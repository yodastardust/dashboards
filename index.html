<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Conversations Dashboard - Mission Control</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&family=Roboto+Mono:wght@400;500&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        /* ========================================
           SpaceX Mission Control Theme
           ======================================== */
        :root {
            --bg-primary: #0b0b0f;
            --bg-secondary: #1a1a1e;
            --bg-panel: #141418;
            --bg-hover: #252529;
            --accent-blue: #005288;
            --accent-cyan: #00bcd4;
            --alert-red: #c41e3a;
            --success-green: #00c853;
            --warning-yellow: #ffc107;
            --warning-orange: #ff8800;
            --text-primary: #ffffff;
            --text-secondary: #9e9e9e;
            --text-muted: #666666;
            --border-color: #2a2a2e;
            --shadow: 0 4px 20px rgba(0, 0, 0, 0.5);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Roboto', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
            line-height: 1.5;
        }

        /* ========================================
           Header
           ======================================== */
        .header {
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border-color);
            padding: 12px 24px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .logo-icon {
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, var(--accent-blue), var(--accent-cyan));
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 18px;
            font-family: 'Roboto Mono', monospace;
        }

        .logo-text {
            font-weight: 500;
            font-size: 18px;
        }

        .logo-text span {
            color: var(--text-secondary);
            font-weight: 300;
        }

        .header-stats {
            display: flex;
            gap: 24px;
            align-items: center;
        }

        .header-stat {
            text-align: center;
        }

        .header-stat-value {
            font-size: 1.25rem;
            font-weight: 700;
            color: var(--accent-cyan);
            font-family: 'Roboto Mono', monospace;
        }

        .header-stat-label {
            font-size: 0.65rem;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .connection-status {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 6px 12px;
            background: var(--bg-panel);
            border-radius: 20px;
            font-size: 0.75rem;
            font-family: 'Roboto Mono', monospace;
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--success-green);
        }

        .status-dot.offline { background: var(--alert-red); }
        .status-dot.syncing { background: var(--warning-orange); animation: pulse 1s infinite; }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.4; }
        }

        /* ========================================
           Container Layout
           ======================================== */
        .container {
            display: flex;
            height: calc(100vh - 65px);
        }

        /* ========================================
           Sidebar
           ======================================== */
        .sidebar {
            width: 320px;
            background: var(--bg-secondary);
            border-right: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
        }

        .search-box {
            padding: 12px;
            border-bottom: 1px solid var(--border-color);
        }

        .search-box input {
            width: 100%;
            padding: 10px 14px;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            background: var(--bg-panel);
            color: var(--text-primary);
            font-size: 0.85rem;
        }

        .search-box input:focus {
            outline: none;
            border-color: var(--accent-cyan);
        }

        .search-box input::placeholder {
            color: var(--text-muted);
        }

        .filters {
            padding: 10px 12px;
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            border-bottom: 1px solid var(--border-color);
        }

        .filter-btn {
            padding: 5px 10px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            background: transparent;
            color: var(--text-secondary);
            cursor: pointer;
            font-size: 0.7rem;
            transition: all 0.2s;
            font-family: 'Roboto Mono', monospace;
        }

        .filter-btn.active {
            background: var(--accent-cyan);
            color: var(--bg-primary);
            border-color: var(--accent-cyan);
        }

        .filter-btn:hover:not(.active) {
            border-color: var(--accent-cyan);
            color: var(--text-primary);
        }

        .contact-list {
            flex: 1;
            overflow-y: auto;
        }

        .contact-item {
            padding: 12px 14px;
            border-bottom: 1px solid var(--border-color);
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
            /* Virtual scrolling optimization for large lists */
            content-visibility: auto;
            contain-intrinsic-size: 0 72px; /* Estimated height of contact item */
        }

        .contact-item:hover {
            background: var(--bg-hover);
        }

        .contact-item.active {
            background: rgba(0, 188, 212, 0.1);
            border-left: 3px solid var(--accent-cyan);
        }

        .contact-item.has-new-message::after {
            content: '';
            position: absolute;
            right: 12px;
            top: 50%;
            transform: translateY(-50%);
            width: 10px;
            height: 10px;
            background: var(--success-green);
            border-radius: 50%;
            animation: pulse 1s infinite;
        }

        .contact-name {
            font-weight: 500;
            margin-bottom: 2px;
            font-size: 0.9rem;
        }

        .contact-phone {
            font-size: 0.8rem;
            color: var(--text-secondary);
            font-family: 'Roboto Mono', monospace;
        }

        .contact-meta {
            display: flex;
            gap: 12px;
            margin-top: 6px;
            font-size: 0.7rem;
        }

        .contact-meta span {
            display: flex;
            align-items: center;
            gap: 4px;
            color: var(--text-muted);
        }

        .meta-icon {
            font-size: 0.8rem;
        }

        .meta-calls { color: var(--accent-cyan); }
        .meta-sms { color: var(--warning-orange); }
        .meta-transcripts { color: var(--success-green); }

        /* ========================================
           Main Content
           ======================================== */
        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            background: var(--bg-primary);
        }

        .contact-header {
            padding: 16px 24px;
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border-color);
        }

        .contact-header h2 {
            font-size: 1.1rem;
            font-weight: 500;
            margin-bottom: 6px;
        }

        .contact-details {
            display: flex;
            gap: 20px;
            font-size: 0.75rem;
            color: var(--text-secondary);
            flex-wrap: wrap;
        }

        .contact-details span {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        /* ========================================
           Tabs
           ======================================== */
        .tabs {
            display: flex;
            padding: 0 24px;
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border-color);
        }

        .tab {
            padding: 12px 16px;
            cursor: pointer;
            border-bottom: 2px solid transparent;
            color: var(--text-secondary);
            transition: all 0.2s;
            font-size: 0.85rem;
        }

        .tab:hover {
            color: var(--text-primary);
        }

        .tab.active {
            color: var(--accent-cyan);
            border-bottom-color: var(--accent-cyan);
        }

        /* ========================================
           Content Area with Merge Fields
           ======================================== */
        .content-wrapper {
            flex: 1;
            display: flex;
            overflow: hidden;
        }

        .tab-content {
            flex: 1;
            overflow-y: auto;
            padding: 16px 24px;
            display: flex;
            flex-direction: column;
        }

        .merge-fields-panel {
            width: 200px;
            background: var(--bg-secondary);
            border-left: 1px solid var(--border-color);
            padding: 12px;
            overflow-y: auto;
            display: none;
        }

        .merge-fields-panel.visible {
            display: block;
        }

        .merge-fields-title {
            font-size: 0.75rem;
            color: var(--text-secondary);
            text-transform: uppercase;
            margin-bottom: 12px;
            font-weight: 500;
        }

        .merge-field {
            background: var(--bg-panel);
            border: 1px solid var(--border-color);
            border-radius: 4px;
            padding: 6px 10px;
            margin-bottom: 8px;
            font-size: 0.75rem;
            font-family: 'Roboto Mono', monospace;
            color: var(--accent-cyan);
            cursor: grab;
            transition: all 0.2s;
        }

        .merge-field:hover {
            border-color: var(--accent-cyan);
            background: var(--bg-hover);
        }

        .merge-field:active {
            cursor: grabbing;
        }

        .merge-field-hint {
            font-size: 0.65rem;
            color: var(--text-muted);
            margin-top: 12px;
            padding-top: 12px;
            border-top: 1px solid var(--border-color);
        }

        /* ========================================
           Timeline
           ======================================== */
        .timeline {
            flex: 1;
        }

        .timeline-item {
            display: flex;
            margin-bottom: 16px;
            align-items: flex-start;
            gap: 12px;
        }

        .timeline-item.inbound {
            flex-direction: row;
        }

        .timeline-item.outbound {
            flex-direction: row-reverse;
        }

        .timeline-icon {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.8rem;
            flex-shrink: 0;
        }

        .timeline-icon.sms {
            background: rgba(255, 136, 0, 0.2);
            color: var(--warning-orange);
        }

        .timeline-icon.call {
            background: rgba(0, 188, 212, 0.2);
            color: var(--accent-cyan);
        }

        .timeline-icon.ai {
            background: rgba(0, 200, 83, 0.2);
            color: var(--success-green);
        }

        .timeline-bubble {
            max-width: 70%;
            padding: 12px 16px;
            border-radius: 12px;
            position: relative;
        }

        .timeline-item.inbound .timeline-bubble {
            background: var(--bg-panel);
            border: 1px solid var(--border-color);
            border-bottom-left-radius: 4px;
        }

        .timeline-item.outbound .timeline-bubble {
            background: var(--accent-blue);
            border-bottom-right-radius: 4px;
        }

        .timeline-item.outbound .timeline-bubble.ai-call {
            background: rgba(0, 200, 83, 0.15);
            border: 1px solid rgba(0, 200, 83, 0.3);
        }

        .timeline-type-badge {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            font-size: 0.65rem;
            text-transform: uppercase;
            margin-bottom: 6px;
            padding: 2px 6px;
            border-radius: 3px;
            font-family: 'Roboto Mono', monospace;
        }

        .badge-sms { background: rgba(255, 136, 0, 0.2); color: var(--warning-orange); }
        .badge-call { background: rgba(0, 188, 212, 0.2); color: var(--accent-cyan); }
        .badge-ai { background: rgba(0, 200, 83, 0.2); color: var(--success-green); }

        .timeline-body {
            font-size: 0.9rem;
            line-height: 1.5;
        }

        .timeline-meta {
            font-size: 0.7rem;
            color: var(--text-muted);
            margin-top: 6px;
            display: flex;
            gap: 12px;
        }

        .timeline-item.outbound .timeline-meta {
            color: rgba(255, 255, 255, 0.6);
        }

        .call-expand-btn {
            background: transparent;
            border: 1px solid var(--border-color);
            color: var(--text-secondary);
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.7rem;
            cursor: pointer;
            margin-top: 8px;
        }

        .call-expand-btn:hover {
            border-color: var(--accent-cyan);
            color: var(--accent-cyan);
        }

        .call-transcript {
            margin-top: 12px;
            padding-top: 12px;
            border-top: 1px solid var(--border-color);
            max-height: 300px;
            overflow-y: auto;
            display: none;
        }

        .call-transcript.expanded {
            display: block;
        }

        .transcript-line {
            margin-bottom: 8px;
            font-size: 0.85rem;
        }

        .transcript-line.agent {
            color: var(--accent-cyan);
        }

        .transcript-line.user {
            color: var(--success-green);
        }

        .transcript-speaker {
            font-weight: 500;
            margin-right: 4px;
        }

        /* ========================================
           Reply Input
           ======================================== */
        .reply-container {
            padding: 16px 24px;
            background: var(--bg-secondary);
            border-top: 1px solid var(--border-color);
        }

        .ai-draft-container {
            background: rgba(0, 200, 83, 0.1);
            border: 1px solid rgba(0, 200, 83, 0.3);
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 12px;
            display: none;
        }

        .ai-draft-container.visible {
            display: block;
        }

        .ai-draft-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .ai-draft-label {
            font-size: 0.75rem;
            color: var(--success-green);
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .ai-countdown {
            font-family: 'Roboto Mono', monospace;
            font-size: 0.8rem;
            color: var(--warning-orange);
        }

        .ai-draft-text {
            font-size: 0.85rem;
            color: var(--text-primary);
            margin-bottom: 10px;
            line-height: 1.5;
        }

        .ai-draft-actions {
            display: flex;
            gap: 8px;
        }

        .ai-btn {
            padding: 6px 12px;
            border-radius: 4px;
            font-size: 0.75rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .ai-btn-use {
            background: var(--success-green);
            color: var(--bg-primary);
            border: none;
        }

        .ai-btn-use:hover {
            background: #00e05f;
        }

        .ai-btn-dismiss {
            background: transparent;
            border: 1px solid var(--border-color);
            color: var(--text-secondary);
        }

        .ai-btn-dismiss:hover {
            border-color: var(--alert-red);
            color: var(--alert-red);
        }

        .reply-input-wrapper {
            display: flex;
            gap: 12px;
            align-items: flex-end;
        }

        .reply-input-container {
            flex: 1;
            position: relative;
        }

        .reply-input {
            width: 100%;
            padding: 12px 14px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            background: var(--bg-panel);
            color: var(--text-primary);
            font-size: 0.9rem;
            resize: none;
            min-height: 44px;
            max-height: 120px;
            font-family: 'Roboto', sans-serif;
        }

        .reply-input:focus {
            outline: none;
            border-color: var(--accent-cyan);
        }

        .reply-input::placeholder {
            color: var(--text-muted);
        }

        .reply-input.drop-target {
            border-color: var(--accent-cyan);
            background: rgba(0, 188, 212, 0.1);
        }

        .char-counter {
            position: absolute;
            right: 10px;
            bottom: 8px;
            font-size: 0.65rem;
            color: var(--text-muted);
            font-family: 'Roboto Mono', monospace;
        }

        .char-counter.warning {
            color: var(--warning-orange);
        }

        .char-counter.danger {
            color: var(--alert-red);
        }

        .send-btn {
            padding: 12px 20px;
            background: var(--accent-cyan);
            color: var(--bg-primary);
            border: none;
            border-radius: 8px;
            font-size: 0.85rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .send-btn:hover:not(:disabled) {
            background: #00d9f5;
        }

        .send-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .send-btn.loading {
            background: var(--text-muted);
        }

        /* ========================================
           Empty/Loading States
           ======================================== */
        .no-selection {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            color: var(--text-muted);
        }

        .no-selection svg {
            width: 64px;
            height: 64px;
            margin-bottom: 16px;
            opacity: 0.3;
        }

        .loading {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 40px;
        }

        .loading-spinner {
            width: 32px;
            height: 32px;
            border: 2px solid var(--border-color);
            border-top-color: var(--accent-cyan);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .empty-state {
            text-align: center;
            padding: 40px;
            color: var(--text-muted);
        }

        .loading-messages {
            text-align: center;
            padding: 40px 20px;
            color: var(--text-secondary);
            font-style: italic;
        }

        .loading-messages::before {
            content: '';
            display: block;
            width: 24px;
            height: 24px;
            margin: 0 auto 12px;
            border: 2px solid var(--border-color);
            border-top-color: var(--accent-cyan);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* ========================================
           Toast Notifications
           ======================================== */
        .toast-container {
            position: fixed;
            top: 80px;
            right: 24px;
            z-index: 1000;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .toast {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 12px 16px;
            display: flex;
            align-items: center;
            gap: 10px;
            box-shadow: var(--shadow);
            animation: slideIn 0.3s ease;
            max-width: 320px;
        }

        .toast.success {
            border-color: var(--success-green);
        }

        .toast.error {
            border-color: var(--alert-red);
        }

        .toast-icon {
            font-size: 1.2rem;
        }

        .toast-message {
            font-size: 0.85rem;
            flex: 1;
        }

        .toast-close {
            background: none;
            border: none;
            color: var(--text-muted);
            cursor: pointer;
            font-size: 1rem;
        }

        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        /* ========================================
           Call Log Table
           ======================================== */
        .call-table {
            width: 100%;
            border-collapse: collapse;
        }

        .call-table th {
            text-align: left;
            padding: 10px 12px;
            font-size: 0.7rem;
            color: var(--text-secondary);
            text-transform: uppercase;
            border-bottom: 1px solid var(--border-color);
            font-weight: 500;
        }

        .call-table td {
            padding: 10px 12px;
            font-size: 0.85rem;
            border-bottom: 1px solid var(--border-color);
        }

        .call-table tr:hover {
            background: var(--bg-hover);
        }

        /* ========================================
           Sentiment & Status Badges
           ======================================== */
        .sentiment-badge {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 0.65rem;
            text-transform: uppercase;
            font-weight: 500;
        }

        .sentiment-positive { background: rgba(0, 200, 83, 0.2); color: var(--success-green); }
        .sentiment-neutral { background: rgba(158, 158, 158, 0.2); color: var(--text-secondary); }
        .sentiment-negative { background: rgba(196, 30, 58, 0.2); color: var(--alert-red); }

        .status-badge {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 0.65rem;
            text-transform: uppercase;
            font-family: 'Roboto Mono', monospace;
        }

        .status-completed { background: rgba(0, 200, 83, 0.2); color: var(--success-green); }
        .status-missed { background: rgba(196, 30, 58, 0.2); color: var(--alert-red); }
        .status-failed { background: rgba(196, 30, 58, 0.2); color: var(--alert-red); }

        /* ========================================
           Call Summary Box
           ======================================== */
        .call-summary {
            background: rgba(0, 188, 212, 0.1);
            border-left: 3px solid var(--accent-cyan);
            padding: 10px 12px;
            margin-top: 10px;
            border-radius: 0 6px 6px 0;
        }

        .call-summary-label {
            font-size: 0.65rem;
            color: var(--accent-cyan);
            text-transform: uppercase;
            margin-bottom: 4px;
            font-weight: 500;
        }

        .call-summary-text {
            font-size: 0.85rem;
            color: var(--text-primary);
        }
    </style>
</head>
<body>
    <!-- Audio for notifications -->
    <audio id="notification-sound" preload="auto">
        <source src="data:audio/mp3;base64,SUQzBAAAAAAAI1RTU0UAAAAPAAADTGF2ZjU4Ljc2LjEwMAAAAAAAAAAAAAAA/+M4wAAAAAAAAAAAAEluZm8AAAAPAAAAAwAAAbAAqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqq1dXV1dXV1dXV1dXV1dXV1dXV1dXV1dXV1dXV1dXV1dXV////////////////////////////////////////////AAAAAExhdmM1OC4xMwAAAAAAAAAAAAAAACQDgAAAAAAAAAGwhFZ+7wAAAAAAAAAAAAAAAAAAAAD/4xjEAAH0AKoAAAAASW5mbwAAAA8AAAADAAACsACqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqrV1dXV1dXV1dXV1dXV1dXV1dXV1dXV1dXV1dXV1dXV1dX///////////////////////////////////////////8AAAAATGF2YzU4LjEzAAAAAAAAAAAAAAACJAOAAAAAAAACsMFgdWkAAAAAAAAAAAAAAAAAAAAA/+MYxAAB9ACqAAAAAP/jGMQAAfQAqgAAAAD/4xjEAAH0AKoAAAAA" type="audio/mp3">
    </audio>

    <!-- Toast Container -->
    <div class="toast-container" id="toast-container"></div>

    <div class="header">
        <div class="logo">
            <div class="logo-icon">MC</div>
            <div class="logo-text">Conversations <span>Dashboard</span></div>
        </div>
        <div class="header-stats">
            <div class="header-stat">
                <div class="header-stat-value" id="total-contacts">-</div>
                <div class="header-stat-label">Leads</div>
            </div>
            <div class="header-stat">
                <div class="header-stat-value" id="total-calls">-</div>
                <div class="header-stat-label">Calls</div>
            </div>
            <div class="header-stat">
                <div class="header-stat-value" id="total-sms">-</div>
                <div class="header-stat-label">SMS</div>
            </div>
            <div class="header-stat">
                <div class="header-stat-value" id="total-transcripts">-</div>
                <div class="header-stat-label">AI Calls</div>
            </div>
            <div class="connection-status">
                <div class="status-dot" id="status-dot"></div>
                <span id="connection-text">Loading...</span>
            </div>
        </div>
    </div>

    <div class="container">
        <div class="sidebar">
            <div class="search-box">
                <input type="text" id="search-input" placeholder="Search name, phone, address...">
            </div>
            <div class="filters">
                <button class="filter-btn active" data-filter="all">All</button>
                <button class="filter-btn" data-filter="with-transcripts">AI Calls</button>
                <button class="filter-btn" data-filter="with-sms">SMS</button>
                <button class="filter-btn" data-filter="high-touch">10+</button>
            </div>
            <div class="contact-list" id="contact-list">
                <div class="loading">
                    <div class="loading-spinner"></div>
                </div>
            </div>
        </div>

        <div class="main-content">
            <div id="no-selection" class="no-selection">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1">
                    <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
                </svg>
                <p>Select a conversation to view</p>
            </div>

            <div id="contact-view" style="display: none; height: 100%; flex-direction: column;">
                <div class="contact-header">
                    <h2 id="selected-name">-</h2>
                    <div class="contact-details">
                        <span id="selected-phone">-</span>
                        <span id="selected-address">-</span>
                        <span id="selected-auction">-</span>
                        <span id="selected-added">-</span>
                    </div>
                </div>

                <div class="tabs">
                    <div class="tab active" data-tab="timeline">Communications</div>
                    <div class="tab" data-tab="transcripts">AI Transcripts</div>
                    <div class="tab" data-tab="sms">SMS Only</div>
                    <div class="tab" data-tab="calls">Call Log</div>
                </div>

                <div class="content-wrapper">
                    <div class="tab-content" id="tab-content">
                        <!-- Content loaded dynamically -->
                    </div>
                    <div class="merge-fields-panel" id="merge-fields-panel">
                        <div class="merge-fields-title">Property Fields</div>
                        <div id="merge-fields-list">
                            <!-- Fields populated dynamically -->
                        </div>
                        <div class="merge-field-hint">Drag into message or click to copy</div>
                    </div>
                </div>

                <div class="reply-container" id="reply-container" style="display: none;">
                    <div class="ai-draft-container" id="ai-draft-container">
                        <div class="ai-draft-header">
                            <span class="ai-draft-label">
                                <span>AI Response</span>
                            </span>
                            <span class="ai-countdown" id="ai-countdown">Auto-send in 3:00</span>
                        </div>
                        <div class="ai-draft-text" id="ai-draft-text">Loading AI response...</div>
                        <div class="ai-draft-actions">
                            <button class="ai-btn ai-btn-use" id="ai-use-btn">Send Now</button>
                            <button class="ai-btn ai-btn-dismiss" id="ai-dismiss-btn">Dismiss</button>
                        </div>
                    </div>
                    <div class="reply-input-wrapper">
                        <div class="reply-input-container">
                            <textarea class="reply-input" id="reply-input" placeholder="Type a message..." rows="1"></textarea>
                            <span class="char-counter" id="char-counter">0/160</span>
                        </div>
                        <button class="send-btn" id="send-btn" disabled>
                            <span>Send</span>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ========================================
        // Configuration
        // ========================================
        const SUPABASE_URL = 'https://saksbjogtkagedmlsrsv.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNha3Niam9ndGthZ2VkbWxzcnN2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjkyNTUxMDMsImV4cCI6MjA4NDYxNTEwM30.FvfTxotEWZlkmQNiekbt4KyxvDk_7GBqfWn55pKTjho';
        const N8N_SEND_SMS_URL = 'https://n8n.stopmyauctionnow.com/webhook/dashboard-send-sms';
        const N8N_AI_DRAFT_URL = 'https://n8n.stopmyauctionnow.com/webhook/dashboard-ai-draft';

        // ========================================
        // State
        // ========================================
        let contactsData = [];
        let selectedContact = null;
        let currentFilter = 'all';
        let currentTab = 'timeline';
        let supabaseClient = null;
        let isSupabaseConnected = false;
        let messagesChannel = null;
        let aiDraftTimer = null;
        let aiDraftSecondsLeft = 0;
        let contactPropertyData = {}; // Cache for merge fields
        let contactsWithNewMessages = new Set();

        // ========================================
        // Initialize
        // ========================================
        async function init() {
            updateConnectionStatus('syncing', 'Connecting...');

            // Helper function for timeout
            const withTimeout = (promise, ms) => {
                return Promise.race([
                    promise,
                    new Promise((_, reject) => setTimeout(() => reject(new Error('Timeout')), ms))
                ]);
            };

            // Initialize Supabase
            if (SUPABASE_URL && SUPABASE_ANON_KEY) {
                try {
                    supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
                    updateConnectionStatus('syncing', 'Loading...');

                    // Query 1: All conversations (no limit!)
                    const { data: conversations, error: convError } = await withTimeout(
                        supabaseClient
                            .from('conversations')
                            .select('*')
                            .order('last_message_at', { ascending: false, nullsFirst: false }),
                        15000  // Increased timeout for larger dataset
                    );

                    if (convError) throw convError;

                    if (conversations && conversations.length > 0) {
                        console.log(`Loaded ${conversations.length} conversations from Supabase`);

                        // Query 2: Enrich with contact details (parallel)
                        const phoneDigits = [...new Set(conversations.map(c => c.phone_digits).filter(Boolean))];
                        const { data: contacts } = await withTimeout(
                            supabaseClient
                                .from('v_agent_contact_context')
                                .select('phone_digits, full_name, owners_name, property_address, city, county, auction_date, auction_type')
                                .in('phone_digits', phoneDigits),
                            10000
                        );

                        console.log(`Enriched with ${contacts?.length || 0} contact details`);

                        // Merge and transform
                        const enriched = mergeConversationsWithContacts(conversations, contacts || []);
                        contactsData = transformSupabaseData(enriched);

                        isSupabaseConnected = true;
                        updateConnectionStatus('online', `Live (${contactsData.length})`);
                        subscribeToMessages();
                    } else {
                        // No data in Supabase, fallback to JSON
                        console.log('No conversations in Supabase, loading from JSON');
                        await loadFromJSON();
                    }
                } catch (e) {
                    console.log('Supabase error, loading from JSON:', e);
                    await loadFromJSON();
                }
            } else {
                await loadFromJSON();
            }

            setupEventListeners();
            renderContactList();
            updateHeaderStats();
        }

        // Merge conversations with contact details from v_agent_contact_context
        function mergeConversationsWithContacts(conversations, contacts) {
            const contactMap = new Map(contacts.map(c => [c.phone_digits, c]));

            return conversations.map(conv => {
                const contact = contactMap.get(conv.phone_digits) || {};
                return {
                    ...conv,
                    full_name: contact.full_name || '',
                    owners_name: contact.owners_name || '',
                    property_address: contact.property_address || '',
                    city: contact.city || '',
                    county: contact.county || '',
                    auction_date: contact.auction_date || '',
                    auction_type: contact.auction_type || ''
                };
            });
        }

        // Transform enriched Supabase data to dashboard format
        function transformSupabaseData(enrichedConversations) {
            return enrichedConversations.map(c => ({
                contact_id: c.conversation_id,
                name: c.full_name || c.owners_name || c.phone_digits,
                phone: formatPhoneNumber(c.phone_digits),
                phone_digits: c.phone_digits,
                conversation_id: c.conversation_id,
                property_address: c.property_address || '',
                city: c.city || '',
                county: c.county || '',
                auction_date: c.auction_date || '',
                auction_type: c.auction_type || '',
                date_added: c.first_seen_at,
                total_touches: (c.inbound_sms_count || 0) + (c.outbound_sms_count || 0) + (c.outbound_call_count || 0),
                inbound_sms_count: c.inbound_sms_count || 0,
                outbound_sms_count: c.outbound_sms_count || 0,
                outbound_call_count: c.outbound_call_count || 0,
                conversation_status: c.status || 'unknown',
                call_details: [],           // Loaded on-demand
                sms_conversation: [],       // Loaded on-demand
                retell_transcriptions: [],  // Not in Supabase yet
                preferred_from_e164: c.preferred_from_e164,
                _messagesLoaded: false      // Track if messages have been loaded
            }));
        }

        // Lazy load messages for a specific contact
        async function loadLeadMessages(phone_digits) {
            if (!supabaseClient) return [];

            try {
                const { data: messages, error } = await supabaseClient
                    .from('messages')
                    .select('direction, body, created_at, status')
                    .eq('phone_digits', phone_digits)
                    .order('created_at', { ascending: true });

                if (error) throw error;

                // Transform to expected format
                return (messages || []).map(m => ({
                    date: m.created_at,
                    direction: m.direction,
                    body: m.body,
                    status: m.status
                }));
            } catch (e) {
                console.error('Error loading messages:', e);
                return [];
            }
        }

        async function loadFromJSON() {
            try {
                const response = await fetch('full_marketing_analysis.json');
                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                contactsData = await response.json();
                updateConnectionStatus('offline', 'Static');
                console.log(`Loaded ${contactsData.length} contacts from JSON`);
            } catch (e) {
                console.log('First JSON fetch failed:', e);
                try {
                    const response = await fetch('./full_marketing_analysis.json');
                    if (!response.ok) throw new Error(`HTTP ${response.status}`);
                    contactsData = await response.json();
                    updateConnectionStatus('offline', 'Static');
                    console.log(`Loaded ${contactsData.length} contacts from JSON (fallback)`);
                } catch (e2) {
                    console.error('Failed to load data from JSON:', e2);
                    contactsData = [];
                    updateConnectionStatus('offline', 'No Data');
                }
            }
        }

        // ========================================
        // Real-time Subscriptions
        // ========================================
        function subscribeToMessages() {
            if (!supabaseClient) return;

            messagesChannel = supabaseClient
                .channel('messages-realtime')
                .on('postgres_changes', {
                    event: 'INSERT',
                    schema: 'public',
                    table: 'messages'
                }, handleNewMessage)
                .subscribe();
        }

        function handleNewMessage(payload) {
            const message = payload.new;
            console.log('New message:', message);

            // Play notification sound for inbound messages
            if (message.direction === 'inbound') {
                playNotificationSound();
                showToast('New message received', 'success');

                // Mark contact as having new message
                const phoneDigits = message.phone_digits;
                contactsWithNewMessages.add(phoneDigits);
                renderContactList();

                // If this contact is selected, add message to view
                if (selectedContact && selectedContact.phone_digits === phoneDigits) {
                    // Add message to conversation
                    if (!selectedContact.sms_conversation) {
                        selectedContact.sms_conversation = [];
                    }
                    selectedContact.sms_conversation.push({
                        date: message.created_at,
                        direction: message.direction,
                        body: message.body
                    });
                    renderTabContent();

                    // Trigger AI draft (only for NEW inbound while dashboard is open)
                    fetchAIDraft(message.body);
                }
            }
        }

        // ========================================
        // AI Auto-Response
        // ========================================
        async function fetchAIDraft(lastInboundMessage) {
            if (!selectedContact) return;

            const draftContainer = document.getElementById('ai-draft-container');
            const draftText = document.getElementById('ai-draft-text');

            draftContainer.classList.add('visible');
            draftText.textContent = 'Generating AI response...';

            try {
                const response = await fetch(N8N_AI_DRAFT_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        phone_digits: selectedContact.phone_digits,
                        conversation_id: selectedContact.conversation_id,
                        last_inbound_message: lastInboundMessage
                    })
                });

                const data = await response.json();

                if (data.draft) {
                    draftText.textContent = resolveMessageMergeFields(data.draft);
                    startAICountdown();
                } else {
                    draftContainer.classList.remove('visible');
                }
            } catch (e) {
                console.error('AI draft error:', e);
                draftContainer.classList.remove('visible');
            }
        }

        function startAICountdown() {
            // Random time between 150-210 seconds (2.5-3.5 minutes)
            aiDraftSecondsLeft = Math.floor(150 + Math.random() * 60);

            if (aiDraftTimer) clearInterval(aiDraftTimer);

            updateAICountdown();
            aiDraftTimer = setInterval(() => {
                aiDraftSecondsLeft--;
                updateAICountdown();

                if (aiDraftSecondsLeft <= 0) {
                    clearInterval(aiDraftTimer);
                    sendAIDraft();
                }
            }, 1000);
        }

        function updateAICountdown() {
            const countdownEl = document.getElementById('ai-countdown');
            const minutes = Math.floor(aiDraftSecondsLeft / 60);
            const seconds = aiDraftSecondsLeft % 60;
            countdownEl.textContent = `Auto-send in ${minutes}:${seconds.toString().padStart(2, '0')}`;
        }

        function cancelAIDraft() {
            if (aiDraftTimer) {
                clearInterval(aiDraftTimer);
                aiDraftTimer = null;
            }
            document.getElementById('ai-draft-container').classList.remove('visible');
        }

        async function sendAIDraft() {
            const draftText = document.getElementById('ai-draft-text').textContent;
            await sendMessage(draftText);
            cancelAIDraft();
        }

        // ========================================
        // Send Message
        // ========================================
        async function sendMessage(message) {
            if (!selectedContact || !message.trim()) return;

            const sendBtn = document.getElementById('send-btn');
            sendBtn.disabled = true;
            sendBtn.classList.add('loading');
            sendBtn.innerHTML = '<span>Sending...</span>';

            try {
                // Resolve any merge fields
                const resolvedMessage = resolveMessageMergeFields(message);

                const response = await fetch(N8N_SEND_SMS_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        phone_digits: selectedContact.phone_digits,
                        message: resolvedMessage,
                        from_number: selectedContact.preferred_from_e164 || '+15617867541'
                    })
                });

                if (response.ok) {
                    // Optimistic update - add message to view immediately
                    if (!selectedContact.sms_conversation) {
                        selectedContact.sms_conversation = [];
                    }
                    selectedContact.sms_conversation.push({
                        date: new Date().toISOString(),
                        direction: 'outbound',
                        body: resolvedMessage
                    });
                    renderTabContent();
                    document.getElementById('reply-input').value = '';
                    updateCharCounter();
                    showToast('Message sent', 'success');

                    // Cancel AI draft since user sent manually
                    cancelAIDraft();
                } else {
                    showToast('Failed to send message', 'error');
                }
            } catch (e) {
                console.error('Send error:', e);
                showToast('Failed to send message', 'error');
            }

            sendBtn.disabled = false;
            sendBtn.classList.remove('loading');
            sendBtn.innerHTML = '<span>Send</span>';
        }

        // ========================================
        // Merge Fields
        // ========================================
        function setupMergeFields() {
            if (!selectedContact) return;

            const panel = document.getElementById('merge-fields-panel');
            const list = document.getElementById('merge-fields-list');

            // Define available merge fields
            const fields = [
                { key: 'owners_name', label: '{{owners_name}}', value: selectedContact.name || '' },
                { key: 'property_address', label: '{{property_address}}', value: selectedContact.property_address || '' },
                { key: 'city', label: '{{city}}', value: contactPropertyData.city || '' },
                { key: 'county', label: '{{county}}', value: contactPropertyData.county || '' },
                { key: 'auction_date', label: '{{auction_date}}', value: selectedContact.auction_date || '' },
                { key: 'auction_type', label: '{{auction_type}}', value: contactPropertyData.auction_type || '' },
                { key: 'final_judgment', label: '{{final_judgment}}', value: contactPropertyData.final_judgment || '' },
                { key: 'zestimate', label: '{{zestimate}}', value: contactPropertyData.zestimate || '' }
            ];

            list.innerHTML = fields.map(f => `
                <div class="merge-field" draggable="true" data-key="${f.key}" data-value="${f.value || f.label}">
                    ${f.label}
                </div>
            `).join('');

            // Setup drag events
            list.querySelectorAll('.merge-field').forEach(field => {
                field.addEventListener('dragstart', (e) => {
                    e.dataTransfer.setData('text/plain', field.dataset.value || field.dataset.key);
                });

                field.addEventListener('click', () => {
                    // Click to insert at cursor
                    const input = document.getElementById('reply-input');
                    const value = field.dataset.value || `{{${field.dataset.key}}}`;
                    const start = input.selectionStart;
                    const end = input.selectionEnd;
                    input.value = input.value.substring(0, start) + value + input.value.substring(end);
                    input.focus();
                    input.setSelectionRange(start + value.length, start + value.length);
                    updateCharCounter();
                });
            });

            panel.classList.add('visible');
        }

        function resolveMessageMergeFields(message) {
            if (!selectedContact) return message;

            const replacements = {
                '{{owners_name}}': selectedContact.name || '',
                '{{property_address}}': selectedContact.property_address || '',
                '{{city}}': contactPropertyData.city || '',
                '{{county}}': contactPropertyData.county || '',
                '{{auction_date}}': selectedContact.auction_date || '',
                '{{auction_type}}': contactPropertyData.auction_type || '',
                '{{final_judgment}}': contactPropertyData.final_judgment || '',
                '{{zestimate}}': contactPropertyData.zestimate || ''
            };

            let resolved = message;
            for (const [key, value] of Object.entries(replacements)) {
                resolved = resolved.replace(new RegExp(key.replace(/[{}]/g, '\\$&'), 'g'), value);
            }
            return resolved;
        }

        // ========================================
        // UI Helpers
        // ========================================
        function updateConnectionStatus(status, text) {
            const dot = document.getElementById('status-dot');
            const textEl = document.getElementById('connection-text');

            dot.className = 'status-dot';
            if (status === 'offline') dot.classList.add('offline');
            if (status === 'syncing') dot.classList.add('syncing');

            textEl.textContent = text;
        }

        function showToast(message, type = 'success') {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.innerHTML = `
                <span class="toast-icon">${type === 'success' ? '' : ''}</span>
                <span class="toast-message">${message}</span>
                <button class="toast-close" onclick="this.parentElement.remove()"></button>
            `;
            container.appendChild(toast);

            setTimeout(() => toast.remove(), 5000);
        }

        function playNotificationSound() {
            const audio = document.getElementById('notification-sound');
            audio.currentTime = 0;
            audio.play().catch(() => {}); // Ignore if blocked
        }

        function formatPhoneNumber(digits) {
            if (!digits || digits.length !== 10) return digits;
            return `(${digits.slice(0,3)}) ${digits.slice(3,6)}-${digits.slice(6)}`;
        }

        function updateCharCounter() {
            const input = document.getElementById('reply-input');
            const counter = document.getElementById('char-counter');
            const len = input.value.length;

            counter.textContent = `${len}/160`;
            counter.className = 'char-counter';

            if (len > 160) {
                counter.classList.add('danger');
            } else if (len > 140) {
                counter.classList.add('warning');
            }

            // Enable/disable send button
            document.getElementById('send-btn').disabled = len === 0;
        }

        // ========================================
        // Event Listeners
        // ========================================
        function setupEventListeners() {
            // Search
            document.getElementById('search-input').addEventListener('input', (e) => {
                renderContactList(e.target.value);
            });

            // Filters
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    currentFilter = btn.dataset.filter;
                    renderContactList();
                });
            });

            // Tabs
            document.querySelectorAll('.tab').forEach(tab => {
                tab.addEventListener('click', () => {
                    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                    tab.classList.add('active');
                    currentTab = tab.dataset.tab;
                    renderTabContent();
                });
            });

            // Reply input
            const replyInput = document.getElementById('reply-input');
            replyInput.addEventListener('input', updateCharCounter);
            replyInput.addEventListener('keydown', (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    if (!document.getElementById('send-btn').disabled) {
                        sendMessage(replyInput.value);
                    }
                }
            });

            // Drag and drop for merge fields
            replyInput.addEventListener('dragover', (e) => {
                e.preventDefault();
                replyInput.classList.add('drop-target');
            });
            replyInput.addEventListener('dragleave', () => {
                replyInput.classList.remove('drop-target');
            });
            replyInput.addEventListener('drop', (e) => {
                e.preventDefault();
                replyInput.classList.remove('drop-target');
                const value = e.dataTransfer.getData('text/plain');
                const start = replyInput.selectionStart;
                replyInput.value = replyInput.value.substring(0, start) + value + replyInput.value.substring(start);
                updateCharCounter();
            });

            // Send button
            document.getElementById('send-btn').addEventListener('click', () => {
                sendMessage(document.getElementById('reply-input').value);
            });

            // AI draft buttons
            document.getElementById('ai-use-btn').addEventListener('click', sendAIDraft);
            document.getElementById('ai-dismiss-btn').addEventListener('click', cancelAIDraft);
        }

        // ========================================
        // Render Functions
        // ========================================
        function filterContacts(contacts, searchTerm = '') {
            let filtered = contacts;

            switch (currentFilter) {
                case 'with-transcripts':
                    filtered = filtered.filter(c => c.retell_transcriptions && c.retell_transcriptions.length > 0);
                    break;
                case 'with-sms':
                    filtered = filtered.filter(c => c.sms_conversation && c.sms_conversation.length > 0);
                    break;
                case 'high-touch':
                    filtered = filtered.filter(c => c.total_touches >= 10);
                    break;
            }

            if (searchTerm) {
                const term = searchTerm.toLowerCase();
                filtered = filtered.filter(c =>
                    (c.name && c.name.toLowerCase().includes(term)) ||
                    (c.phone && c.phone.includes(term)) ||
                    (c.property_address && c.property_address.toLowerCase().includes(term))
                );
            }

            return filtered;
        }

        function renderContactList(searchTerm = '') {
            const list = document.getElementById('contact-list');
            const filtered = filterContacts(contactsData, searchTerm);

            if (filtered.length === 0) {
                list.innerHTML = '<div class="empty-state">No contacts found</div>';
                return;
            }

            list.innerHTML = filtered.map(contact => {
                const hasNewMessage = contactsWithNewMessages.has(contact.phone_digits);
                // Use summary counts if available (from Supabase), otherwise fall back to array length (from JSON)
                const callCount = contact.outbound_call_count || (contact.call_details ? contact.call_details.length : 0);
                const smsCount = (contact.inbound_sms_count || 0) + (contact.outbound_sms_count || 0) || (contact.sms_conversation ? contact.sms_conversation.length : 0);
                const transcriptCount = contact.retell_transcriptions ? contact.retell_transcriptions.length : 0;
                return `
                    <div class="contact-item ${selectedContact && selectedContact.contact_id === contact.contact_id ? 'active' : ''} ${hasNewMessage ? 'has-new-message' : ''}"
                         data-id="${contact.contact_id}">
                        <div class="contact-name">${contact.name || 'Unknown'}</div>
                        <div class="contact-phone">${contact.phone || '-'}</div>
                        <div class="contact-meta">
                            <span class="meta-calls"><span class="meta-icon"></span> ${callCount}</span>
                            <span class="meta-sms"><span class="meta-icon"></span> ${smsCount}</span>
                            <span class="meta-transcripts"><span class="meta-icon"></span> ${transcriptCount}</span>
                        </div>
                    </div>
                `;
            }).join('');

            list.querySelectorAll('.contact-item').forEach(item => {
                item.addEventListener('click', () => {
                    const contact = contactsData.find(c => c.contact_id === item.dataset.id);
                    selectContact(contact);
                });
            });
        }

        async function selectContact(contact) {
            selectedContact = contact;

            // Clear new message indicator
            if (contact.phone_digits) {
                contactsWithNewMessages.delete(contact.phone_digits);
            }

            // Cancel any existing AI draft
            cancelAIDraft();

            document.getElementById('no-selection').style.display = 'none';
            document.getElementById('contact-view').style.display = 'flex';
            document.getElementById('reply-container').style.display = 'block';

            document.getElementById('selected-name').textContent = contact.name || 'Unknown';
            document.getElementById('selected-phone').textContent = ` ${contact.phone || '-'}`;
            document.getElementById('selected-address').textContent = contact.property_address ? ` ${contact.property_address}` : '';
            document.getElementById('selected-auction').textContent = contact.auction_date ? ` ${contact.auction_date}` : '';
            document.getElementById('selected-added').textContent = contact.date_added ? ` ${formatDate(contact.date_added)}` : '';

            document.querySelectorAll('.contact-item').forEach(item => {
                item.classList.toggle('active', item.dataset.id === contact.contact_id);
            });

            setupMergeFields();

            // Lazy load messages if using Supabase and not yet loaded
            if (isSupabaseConnected && !contact._messagesLoaded) {
                // Show loading state
                const content = document.getElementById('tab-content');
                content.innerHTML = '<div class="loading-messages">Loading messages...</div>';

                // Load messages
                contact.sms_conversation = await loadLeadMessages(contact.phone_digits);
                contact._messagesLoaded = true;

                console.log(`Loaded ${contact.sms_conversation.length} messages for ${contact.phone_digits}`);
            }

            renderTabContent();
        }

        function renderTabContent() {
            if (!selectedContact) return;

            const content = document.getElementById('tab-content');

            switch (currentTab) {
                case 'timeline':
                    renderTimeline(content);
                    break;
                case 'transcripts':
                    renderTranscripts(content);
                    break;
                case 'sms':
                    renderSMS(content);
                    break;
                case 'calls':
                    renderCalls(content);
                    break;
            }
        }

        function renderTimeline(container) {
            const events = [];

            if (selectedContact.call_details) {
                selectedContact.call_details.forEach(call => {
                    events.push({ type: 'call', date: new Date(call.date), data: call });
                });
            }

            if (selectedContact.sms_conversation) {
                selectedContact.sms_conversation.forEach(sms => {
                    events.push({ type: 'sms', date: new Date(sms.date), data: sms });
                });
            }

            if (selectedContact.retell_transcriptions) {
                selectedContact.retell_transcriptions.forEach(transcript => {
                    events.push({ type: 'ai', date: new Date(transcript.date), data: transcript });
                });
            }

            events.sort((a, b) => b.date - a.date);

            if (events.length === 0) {
                container.innerHTML = '<div class="empty-state">No communications recorded</div>';
                return;
            }

            container.innerHTML = `<div class="timeline">${events.map(renderTimelineItem).join('')}</div>`;

            // Setup expand buttons for AI calls
            container.querySelectorAll('.call-expand-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    const transcript = btn.nextElementSibling;
                    transcript.classList.toggle('expanded');
                    btn.textContent = transcript.classList.contains('expanded') ? 'Hide Transcript' : 'Show Transcript';
                });
            });
        }

        function renderTimelineItem(event) {
            const { type, date, data } = event;
            const direction = type === 'sms' ? data.direction :
                              type === 'call' ? (data.direction?.includes('originating') ? 'inbound' : 'outbound') :
                              (data.direction === 'inbound' ? 'inbound' : 'outbound');

            let icon, badge, body, meta = '';

            switch (type) {
                case 'sms':
                    icon = '<div class="timeline-icon sms"></div>';
                    badge = '<span class="timeline-type-badge badge-sms">SMS</span>';
                    body = data.body || 'No message content';
                    meta = `<span>${formatDateTime(date)}</span>`;
                    break;

                case 'call':
                    icon = '<div class="timeline-icon call"></div>';
                    badge = '<span class="timeline-type-badge badge-call">CALL</span>';
                    body = `Duration: ${data.duration || 0}s  Status: ${data.status}`;
                    meta = `<span>${formatDateTime(date)}</span><span>${data.from}  ${data.to}</span>`;
                    break;

                case 'ai':
                    icon = '<div class="timeline-icon ai"></div>';
                    badge = '<span class="timeline-type-badge badge-ai">AI CALL</span>';
                    const sentiment = data.user_sentiment || 'Neutral';
                    const sentimentClass = sentiment.toLowerCase() === 'positive' ? 'sentiment-positive' :
                                          sentiment.toLowerCase() === 'negative' ? 'sentiment-negative' : 'sentiment-neutral';
                    body = `
                        <span class="sentiment-badge ${sentimentClass}">${sentiment}</span>
                        <div style="margin-top: 8px;">Duration: ${Math.round(data.duration_sec || 0)}s  ${data.call_successful ? 'Successful' : 'Failed'}</div>
                        ${data.call_summary ? `<div class="call-summary"><div class="call-summary-label">AI Summary</div><div class="call-summary-text">${data.call_summary}</div></div>` : ''}
                        <button class="call-expand-btn">Show Transcript</button>
                        <div class="call-transcript">${formatTranscript(data.transcript)}</div>
                    `;
                    meta = `<span>${formatDateTime(date)}</span>`;
                    break;
            }

            return `
                <div class="timeline-item ${direction}">
                    ${icon}
                    <div class="timeline-bubble ${type === 'ai' ? 'ai-call' : ''}">
                        ${badge}
                        <div class="timeline-body">${body}</div>
                        <div class="timeline-meta">${meta}</div>
                    </div>
                </div>
            `;
        }

        function renderTranscripts(container) {
            const transcripts = selectedContact.retell_transcriptions || [];

            if (transcripts.length === 0) {
                container.innerHTML = '<div class="empty-state">No AI call transcripts available</div>';
                return;
            }

            container.innerHTML = transcripts.map(t => {
                const sentiment = t.user_sentiment || 'Neutral';
                const sentimentClass = sentiment.toLowerCase() === 'positive' ? 'sentiment-positive' :
                                      sentiment.toLowerCase() === 'negative' ? 'sentiment-negative' : 'sentiment-neutral';
                return `
                    <div class="timeline-item outbound" style="flex-direction: column; align-items: stretch;">
                        <div class="timeline-bubble ai-call" style="max-width: 100%;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                                <span class="timeline-type-badge badge-ai">AI CALL</span>
                                <span style="font-size: 0.75rem; color: var(--text-muted);">${formatDateTime(new Date(t.date))}</span>
                            </div>
                            <div style="display: flex; gap: 16px; margin-bottom: 12px;">
                                <span>Duration: ${Math.round(t.duration_sec || 0)}s</span>
                                <span>${t.call_successful ? ' Successful' : ' Failed'}</span>
                                <span class="sentiment-badge ${sentimentClass}">${sentiment}</span>
                            </div>
                            ${t.call_summary ? `<div class="call-summary"><div class="call-summary-label">AI Summary</div><div class="call-summary-text">${t.call_summary}</div></div>` : ''}
                            <div style="margin-top: 12px; background: var(--bg-primary); padding: 12px; border-radius: 8px; max-height: 400px; overflow-y: auto;">
                                ${formatTranscript(t.transcript)}
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function renderSMS(container) {
            const messages = selectedContact.sms_conversation || [];

            if (messages.length === 0) {
                container.innerHTML = '<div class="empty-state">No SMS messages recorded</div>';
                return;
            }

            container.innerHTML = `<div class="timeline">${messages.map(msg => `
                <div class="timeline-item ${msg.direction}">
                    <div class="timeline-icon sms"></div>
                    <div class="timeline-bubble">
                        <div class="timeline-body">${msg.body || 'No message content'}</div>
                        <div class="timeline-meta"><span>${formatDateTime(new Date(msg.date))}</span></div>
                    </div>
                </div>
            `).join('')}</div>`;
        }

        function renderCalls(container) {
            const calls = selectedContact.call_details || [];

            if (calls.length === 0) {
                container.innerHTML = '<div class="empty-state">No calls recorded</div>';
                return;
            }

            container.innerHTML = `
                <table class="call-table">
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Direction</th>
                            <th>Duration</th>
                            <th>Status</th>
                            <th>From  To</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${calls.map(call => {
                            const dir = call.direction?.includes('originating') ? 'Inbound' : 'Outbound';
                            const statusClass = call.status === 'completed' ? 'status-completed' :
                                               call.status === 'no-answer' ? 'status-missed' : 'status-failed';
                            return `
                                <tr>
                                    <td>${formatDateTime(new Date(call.date))}</td>
                                    <td><span class="status-badge ${statusClass}">${dir}</span></td>
                                    <td>${call.duration || 0}s</td>
                                    <td>${call.status}</td>
                                    <td style="font-size: 0.8rem; color: var(--text-muted);">${call.from}  ${call.to}</td>
                                </tr>
                            `;
                        }).join('')}
                    </tbody>
                </table>
            `;
        }

        function formatTranscript(transcript) {
            if (!transcript) return '<em style="color: var(--text-muted);">No transcript available</em>';

            const lines = transcript.split('\n').filter(l => l.trim());
            return lines.map(line => {
                if (line.startsWith('Agent:')) {
                    return `<div class="transcript-line agent"><span class="transcript-speaker">Agent:</span>${line.replace('Agent:', '')}</div>`;
                } else if (line.startsWith('User:')) {
                    return `<div class="transcript-line user"><span class="transcript-speaker">User:</span>${line.replace('User:', '')}</div>`;
                }
                return `<div class="transcript-line">${line}</div>`;
            }).join('');
        }

        function formatDate(dateStr) {
            try {
                return new Date(dateStr).toLocaleDateString('en-US', {
                    year: 'numeric', month: 'short', day: 'numeric'
                });
            } catch { return dateStr; }
        }

        function formatDateTime(date) {
            try {
                return date.toLocaleString('en-US', {
                    month: 'short', day: 'numeric',
                    hour: 'numeric', minute: '2-digit', hour12: true
                });
            } catch { return date.toString(); }
        }

        function updateHeaderStats() {
            document.getElementById('total-contacts').textContent = contactsData.length;

            let totalCalls = 0, totalSMS = 0, totalTranscripts = 0;
            contactsData.forEach(c => {
                totalCalls += (c.call_details || []).length;
                totalSMS += (c.sms_conversation || []).length;
                totalTranscripts += (c.retell_transcriptions || []).length;
            });

            document.getElementById('total-calls').textContent = totalCalls.toLocaleString();
            document.getElementById('total-sms').textContent = totalSMS.toLocaleString();
            document.getElementById('total-transcripts').textContent = totalTranscripts.toLocaleString();
        }

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
