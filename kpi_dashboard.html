<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KPI Dashboard - Mission Control</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&family=Roboto+Mono:wght@400;500&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        /* ========================================
           SpaceX Mission Control Theme
           v5.0 - 2026-02-08 - Full redesign: accuracy-first, real 90-day averages
           ======================================== */
        :root {
            --bg-primary: #0b0b0f;
            --bg-secondary: #1a1a1e;
            --bg-panel: #141418;
            --bg-hover: #252529;
            --accent-blue: #005288;
            --accent-cyan: #00bcd4;
            --accent-purple: #9c27b0;
            --alert-red: #c41e3a;
            --success-green: #00c853;
            --warning-yellow: #ffc107;
            --warning-orange: #ff8800;
            --text-primary: #ffffff;
            --text-secondary: #9e9e9e;
            --text-muted: #666666;
            --border-color: #2a2a2e;
            --shadow: 0 4px 20px rgba(0, 0, 0, 0.5);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Roboto', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--bg-primary);
            min-height: 100vh;
            color: var(--text-primary);
            line-height: 1.5;
        }

        /* Header */
        .header {
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border-color);
            padding: 12px 24px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header h1 {
            font-size: 1.25rem;
            font-weight: 500;
            color: var(--text-primary);
        }

        .header-controls {
            display: flex;
            gap: 15px;
            align-items: center;
        }

        .date-filter {
            padding: 8px 15px;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            background: var(--bg-panel);
            color: var(--text-primary);
            font-size: 0.85rem;
            cursor: pointer;
            outline: none;
        }

        .date-filter:hover, .date-filter:focus {
            border-color: var(--accent-cyan);
        }

        .refresh-btn {
            padding: 8px 20px;
            background: var(--accent-cyan);
            border: none;
            border-radius: 6px;
            color: var(--bg-primary);
            cursor: pointer;
            font-weight: 500;
            transition: all 0.2s;
        }

        .refresh-btn:hover {
            background: var(--accent-blue);
            color: var(--text-primary);
        }

        .main-content {
            padding: 20px 24px;
        }

        /* Section Headers */
        .section-header {
            font-size: 0.85rem;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 1px;
            margin: 25px 0 15px 0;
            padding-bottom: 8px;
            border-bottom: 1px solid var(--border-color);
        }

        .section-header:first-of-type { margin-top: 0; }

        /* KPI Cards Grid (Section 1) */
        .kpi-grid {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 15px;
            margin-bottom: 25px;
        }

        .kpi-card {
            background: var(--bg-panel);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 20px;
            position: relative;
        }

        .kpi-label {
            font-size: 0.75rem;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 8px;
        }

        .kpi-value {
            font-size: 2rem;
            font-weight: 700;
            font-family: 'Roboto Mono', monospace;
            color: var(--text-primary);
        }

        .kpi-compare {
            display: flex;
            gap: 15px;
            margin-top: 10px;
            font-size: 0.8rem;
        }

        .kpi-avg {
            color: var(--text-muted);
        }

        .kpi-change {
            font-weight: 500;
        }

        .kpi-change.up { color: var(--success-green); }
        .kpi-change.down { color: var(--alert-red); }
        .kpi-change.neutral { color: var(--warning-yellow); }
        .kpi-change.cost-up { color: var(--alert-red); }
        .kpi-change.cost-down { color: var(--success-green); }

        .kpi-indicator {
            position: absolute;
            top: 15px;
            right: 15px;
            width: 12px;
            height: 12px;
            border-radius: 50%;
        }

        .kpi-indicator.good { background: var(--success-green); }
        .kpi-indicator.warning { background: var(--warning-yellow); }
        .kpi-indicator.alert { background: var(--alert-red); }

        /* Channel Stats Grid (Section 2) */
        .channel-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 25px;
        }

        .channel-card {
            background: var(--bg-panel);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 20px;
        }

        .channel-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .channel-title {
            font-size: 1.1rem;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .channel-icon {
            width: 32px;
            height: 32px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1rem;
        }

        .channel-icon.sms { background: rgba(0, 188, 212, 0.2); color: var(--accent-cyan); }
        .channel-icon.voice { background: rgba(0, 200, 83, 0.2); color: var(--success-green); }

        .rate-badge {
            padding: 6px 14px;
            border-radius: 20px;
            font-size: 1rem;
            font-weight: 700;
            font-family: 'Roboto Mono', monospace;
        }

        .rate-badge.good { background: rgba(0, 200, 83, 0.2); color: var(--success-green); }
        .rate-badge.medium { background: rgba(255, 193, 7, 0.2); color: var(--warning-yellow); }
        .rate-badge.low { background: rgba(196, 30, 58, 0.2); color: var(--alert-red); }

        .channel-metrics {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
        }

        .metric-box {
            text-align: center;
            padding: 15px;
            background: var(--bg-secondary);
            border-radius: 6px;
        }

        .metric-value {
            font-size: 1.8rem;
            font-weight: 700;
            font-family: 'Roboto Mono', monospace;
            color: var(--text-primary);
        }

        .metric-value.outbound { color: var(--accent-cyan); }
        .metric-value.inbound { color: var(--success-green); }

        .metric-label {
            font-size: 0.75rem;
            color: var(--text-muted);
            text-transform: uppercase;
            margin-top: 5px;
        }

        .metric-sub {
            font-size: 0.7rem;
            margin-top: 8px;
            padding-top: 8px;
            border-top: 1px solid var(--border-color);
            color: var(--text-muted);
        }

        .metric-sub .change { margin-left: 8px; font-weight: 600; }
        .metric-sub .change.up { color: var(--success-green); }
        .metric-sub .change.down { color: var(--alert-red); }

        /* Appointments Section (Section 3) */
        .appt-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 25px;
        }

        .appt-card {
            background: var(--bg-panel);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 20px;
        }

        .appt-title {
            font-size: 1rem;
            font-weight: 500;
            margin-bottom: 15px;
            color: var(--text-secondary);
        }

        .appt-stats {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
        }

        .appt-stat {
            text-align: center;
            padding: 12px 8px;
            background: var(--bg-secondary);
            border-radius: 6px;
        }

        .appt-stat-value {
            font-size: 1.5rem;
            font-weight: 700;
            font-family: 'Roboto Mono', monospace;
            color: var(--accent-cyan);
        }

        .appt-stat-value.showed { color: var(--success-green); }
        .appt-stat-value.noshow { color: var(--alert-red); }
        .appt-stat-value.rate { color: var(--warning-yellow); }

        .appt-stat-label {
            font-size: 0.7rem;
            color: var(--text-muted);
            text-transform: uppercase;
            margin-top: 5px;
        }

        /* Appointment Results Breakdown */
        .appt-results {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid var(--border-color);
        }
        .appt-results-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        .appt-results-title {
            font-size: 0.75rem;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .appt-results-loading {
            font-size: 0.7rem;
            color: var(--text-muted);
            font-style: italic;
        }
        .appt-results-loading.hidden { display: none; }
        .appt-results-bars { display: flex; flex-direction: column; gap: 6px; }
        .result-row { display: flex; align-items: center; gap: 8px; }
        .result-label {
            font-size: 0.7rem;
            color: var(--text-secondary);
            min-width: 120px;
            text-align: right;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .result-bar-track {
            flex: 1;
            height: 16px;
            background: var(--bg-secondary);
            border-radius: 3px;
            overflow: hidden;
        }
        .result-bar-fill {
            height: 100%;
            border-radius: 3px;
            transition: width 0.5s ease;
            min-width: 2px;
        }
        .result-count {
            font-size: 0.7rem;
            font-family: 'Roboto Mono', monospace;
            color: var(--text-primary);
            min-width: 24px;
            text-align: right;
        }
        .result-bar-fill.nurture { background: var(--warning-yellow); }
        .result-bar-fill.second-booked { background: var(--success-green); }
        .result-bar-fill.hot-lead { background: var(--success-green); }
        .result-bar-fill.po-sent { background: #2196f3; }
        .result-bar-fill.disqualified { background: var(--alert-red); }
        .result-bar-fill.referral { background: #9c27b0; }
        .result-bar-fill.dnc { background: #666; }
        .result-bar-fill.unknown-result { background: var(--text-muted); }
        .appt-results-empty {
            font-size: 0.75rem;
            color: var(--text-muted);
            text-align: center;
            padding: 8px 0;
        }
        .appt-results-capped {
            font-size: 0.65rem;
            color: var(--text-muted);
            text-align: right;
            margin-top: 4px;
            font-style: italic;
        }

        /* Cost Grid (Section 4) */
        .cost-grid {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 15px;
            margin-bottom: 25px;
        }

        .cost-card {
            background: var(--bg-panel);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 20px;
        }

        .cost-label {
            font-size: 0.75rem;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 8px;
        }

        .cost-value {
            font-size: 1.8rem;
            font-weight: 700;
            font-family: 'Roboto Mono', monospace;
            color: var(--text-primary);
        }

        .cost-detail {
            font-size: 0.8rem;
            color: var(--text-muted);
            margin-top: 8px;
        }

        .cost-sub {
            font-size: 0.75rem;
            color: var(--text-muted);
            margin-top: 8px;
            padding-top: 8px;
            border-top: 1px solid var(--border-color);
        }

        .cost-sub .change { font-weight: 600; }
        .cost-sub .change.cost-up { color: var(--alert-red); }
        .cost-sub .change.cost-down { color: var(--success-green); }

        /* Queue Grid (Section 5) */
        .queue-grid {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 15px;
            margin-bottom: 25px;
        }

        .queue-card {
            background: var(--bg-panel);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 20px;
        }

        .queue-label {
            font-size: 0.75rem;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 8px;
        }

        .queue-value {
            font-size: 2rem;
            font-weight: 700;
            font-family: 'Roboto Mono', monospace;
        }

        .queue-sub {
            font-size: 0.8rem;
            color: var(--text-muted);
            margin-top: 5px;
        }

        /* Voice Outcomes (inside Section 2) */
        .outcomes-section {
            background: var(--bg-panel);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 25px;
        }

        .outcomes-title {
            font-size: 1rem;
            color: var(--text-secondary);
            margin-bottom: 15px;
        }

        .outcomes-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 15px;
        }

        .outcome-box {
            text-align: center;
            padding: 15px;
            background: var(--bg-secondary);
            border-radius: 6px;
            border-left: 3px solid transparent;
        }

        .outcome-box.completed { border-left-color: var(--success-green); }
        .outcome-box.no-answer { border-left-color: var(--warning-yellow); }
        .outcome-box.failed { border-left-color: var(--alert-red); }
        .outcome-box.busy { border-left-color: var(--warning-orange); }

        .outcome-value {
            font-size: 1.5rem;
            font-weight: 700;
            font-family: 'Roboto Mono', monospace;
        }

        .outcome-value.completed { color: var(--success-green); }
        .outcome-value.no-answer { color: var(--warning-yellow); }
        .outcome-value.failed { color: var(--alert-red); }
        .outcome-value.busy { color: var(--warning-orange); }

        .outcome-label {
            font-size: 0.7rem;
            color: var(--text-muted);
            text-transform: uppercase;
            margin-top: 5px;
        }

        .outcome-pct {
            font-size: 0.85rem;
            color: var(--text-secondary);
            margin-top: 3px;
        }

        /* Charts Grid (Section 6) */
        .charts-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 25px;
        }

        .chart-card {
            background: var(--bg-panel);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 20px;
        }

        .chart-title {
            font-size: 1rem;
            margin-bottom: 15px;
            color: var(--text-secondary);
            font-weight: 500;
        }

        .chart-container {
            height: 200px;
            position: relative;
        }

        /* Status indicators */
        .status-dot {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 8px;
        }

        .status-dot.live {
            background: var(--success-green);
            animation: pulse 2s infinite;
            box-shadow: 0 0 10px var(--success-green);
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; box-shadow: 0 0 5px var(--success-green); }
            50% { opacity: 0.5; box-shadow: 0 0 15px var(--success-green); }
        }

        /* Footer */
        .footer {
            padding: 15px 24px;
            text-align: center;
            color: var(--text-muted);
            font-size: 0.8rem;
            border-top: 1px solid var(--border-color);
        }

        /* Loading */
        .loading-overlay {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .loading-overlay.hidden { display: none; }

        .spinner {
            width: 50px;
            height: 50px;
            border: 4px solid var(--border-color);
            border-top-color: var(--accent-cyan);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin { to { transform: rotate(360deg); } }

        /* Error state */
        .error-text { color: var(--alert-red); font-size: 0.75rem; }

        /* Responsive */
        @media (max-width: 1400px) {
            .kpi-grid { grid-template-columns: repeat(3, 1fr); }
            .cost-grid { grid-template-columns: repeat(3, 1fr); }
            .queue-grid { grid-template-columns: repeat(3, 1fr); }
        }

        @media (max-width: 1200px) {
            .channel-grid { grid-template-columns: 1fr; }
            .appt-grid { grid-template-columns: 1fr; }
        }

        @media (max-width: 768px) {
            .kpi-grid { grid-template-columns: 1fr; }
            .cost-grid { grid-template-columns: 1fr; }
            .queue-grid { grid-template-columns: 1fr; }
            .charts-grid { grid-template-columns: 1fr; }
            .outcomes-grid { grid-template-columns: repeat(2, 1fr); }
            .appt-stats { grid-template-columns: repeat(2, 1fr); }
        }
    </style>
</head>
<body>
    <div id="loadingOverlay" class="loading-overlay">
        <div class="spinner"></div>
    </div>

    <div class="header">
        <h1><span class="status-dot live"></span>KPI Dashboard <span style="color: var(--text-muted); font-weight: 300;">| Real-Time Metrics</span></h1>
        <div class="header-controls">
            <select id="dateFilter" class="date-filter" onchange="refreshData()">
                <option value="today">Today</option>
                <option value="7d" selected>Last 7 Days</option>
                <option value="30d">Last 30 Days</option>
                <option value="90d">Last 90 Days</option>
            </select>
            <button class="refresh-btn" onclick="refreshData()">Refresh</button>
        </div>
    </div>

    <div class="main-content">

        <!-- Section 1: Key Metrics -->
        <div class="section-header" id="kpiHeader">Key Metrics (Last 30 Days)</div>
        <div class="kpi-grid">
            <div class="kpi-card">
                <div class="kpi-indicator" id="firstApptInd"></div>
                <div class="kpi-label">1st Appts Booked</div>
                <div class="kpi-value" id="firstApptVal">--</div>
                <div class="kpi-compare">
                    <span class="kpi-avg">90d avg: <span id="firstAppt90">--</span>/day</span>
                    <span class="kpi-change" id="firstApptChg">--%</span>
                </div>
            </div>
            <div class="kpi-card">
                <div class="kpi-indicator" id="secondApptInd"></div>
                <div class="kpi-label">2nd Appts Booked</div>
                <div class="kpi-value" id="secondApptVal">--</div>
                <div class="kpi-compare">
                    <span class="kpi-avg">90d avg: <span id="secondAppt90">--</span>/day</span>
                    <span class="kpi-change" id="secondApptChg">--%</span>
                </div>
            </div>
            <div class="kpi-card">
                <div class="kpi-indicator" id="respRateInd"></div>
                <div class="kpi-label">SMS Response Rate</div>
                <div class="kpi-value" id="respRateVal">--%</div>
                <div class="kpi-compare">
                    <span class="kpi-avg">90d avg: <span id="respRate90">--</span>%</span>
                    <span class="kpi-change" id="respRateChg">--%</span>
                </div>
            </div>
            <div class="kpi-card">
                <div class="kpi-indicator" id="totalSpendInd"></div>
                <div class="kpi-label">Total Spend</div>
                <div class="kpi-value" id="totalSpendVal">$--</div>
                <div class="kpi-compare">
                    <span class="kpi-avg">90d avg: $<span id="totalSpend90">--</span>/day</span>
                    <span class="kpi-change" id="totalSpendChg">--%</span>
                </div>
            </div>
            <div class="kpi-card">
                <div class="kpi-indicator" id="cpaInd"></div>
                <div class="kpi-label">Cost / 1st Appt</div>
                <div class="kpi-value" id="cpaVal">$--</div>
                <div class="kpi-compare">
                    <span class="kpi-avg">90d avg: $<span id="cpa90">--</span></span>
                    <span class="kpi-change" id="cpaChg">--%</span>
                </div>
            </div>
        </div>

        <!-- Section 2: Outreach Volume -->
        <div class="section-header" id="outreachHeader">Outreach Volume (Last 30 Days)</div>
        <div class="channel-grid">
            <!-- SMS Channel -->
            <div class="channel-card">
                <div class="channel-header">
                    <div class="channel-title">
                        <div class="channel-icon sms">SMS</div>
                        SMS Channel
                    </div>
                    <div class="rate-badge good" id="smsRateBadge">--.--%</div>
                </div>
                <div class="channel-metrics">
                    <div class="metric-box">
                        <div class="metric-value outbound" id="smsSent">--</div>
                        <div class="metric-label">Sent</div>
                        <div class="metric-sub">90d: <span id="smsSent90">--</span>/day <span class="change" id="smsSentChg">--%</span></div>
                    </div>
                    <div class="metric-box">
                        <div class="metric-value inbound" id="smsReceived">--</div>
                        <div class="metric-label">Received</div>
                        <div class="metric-sub">90d: <span id="smsRecv90">--</span>/day <span class="change" id="smsRecvChg">--%</span></div>
                    </div>
                    <div class="metric-box">
                        <div class="metric-value" id="smsRespRate">--.--%</div>
                        <div class="metric-label">Response Rate</div>
                        <div class="metric-sub">90d avg: <span id="smsResp90">--%</span></div>
                    </div>
                </div>
            </div>

            <!-- Voice Channel -->
            <div class="channel-card">
                <div class="channel-header">
                    <div class="channel-title">
                        <div class="channel-icon voice">TEL</div>
                        Voice Channel (Retell AI)
                    </div>
                    <div class="rate-badge good" id="voiceRateBadge">--.--%</div>
                </div>
                <div class="channel-metrics">
                    <div class="metric-box">
                        <div class="metric-value outbound" id="voiceMade">--</div>
                        <div class="metric-label">Calls Made</div>
                        <div class="metric-sub">90d: <span id="voiceMade90">--</span>/day <span class="change" id="voiceMadeChg">--%</span></div>
                    </div>
                    <div class="metric-box">
                        <div class="metric-value inbound" id="voiceAnswered">--</div>
                        <div class="metric-label">Answered</div>
                        <div class="metric-sub">90d: <span id="voiceAns90">--</span>/day <span class="change" id="voiceAnsChg">--%</span></div>
                    </div>
                    <div class="metric-box">
                        <div class="metric-value" id="voiceAnsRate">--.--%</div>
                        <div class="metric-label">Answer Rate</div>
                        <div class="metric-sub">90d avg: <span id="voiceAnsRate90">--%</span></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Voice Call Outcomes -->
        <div class="outcomes-section">
            <div class="outcomes-title" id="outcomesTitle">Voice Call Outcomes</div>
            <div class="outcomes-grid">
                <div class="outcome-box completed">
                    <div class="outcome-value completed" id="outCompleted">--</div>
                    <div class="outcome-label">Completed</div>
                    <div class="outcome-pct" id="outCompletedPct">--%</div>
                </div>
                <div class="outcome-box no-answer">
                    <div class="outcome-value no-answer" id="outVoicemail">--</div>
                    <div class="outcome-label">Voicemail / No Answer</div>
                    <div class="outcome-pct" id="outVoicemailPct">--%</div>
                </div>
                <div class="outcome-box failed">
                    <div class="outcome-value failed" id="outFailed">--</div>
                    <div class="outcome-label">Failed</div>
                    <div class="outcome-pct" id="outFailedPct">--%</div>
                </div>
                <div class="outcome-box busy">
                    <div class="outcome-value busy" id="outBusy">--</div>
                    <div class="outcome-label">Busy</div>
                    <div class="outcome-pct" id="outBusyPct">--%</div>
                </div>
            </div>
        </div>

        <!-- Section 3: Appointments -->
        <div class="section-header" id="apptHeader">Appointments</div>
        <div class="appt-grid">
            <div class="appt-card">
                <div class="appt-title">1st Appointments</div>
                <div class="appt-stats">
                    <div class="appt-stat">
                        <div class="appt-stat-value" id="first_booked">--</div>
                        <div class="appt-stat-label">Booked</div>
                    </div>
                    <div class="appt-stat">
                        <div class="appt-stat-value showed" id="first_showed">--</div>
                        <div class="appt-stat-label">Showed</div>
                    </div>
                    <div class="appt-stat">
                        <div class="appt-stat-value noshow" id="first_noshow">--</div>
                        <div class="appt-stat-label">No-Show</div>
                    </div>
                    <div class="appt-stat">
                        <div class="appt-stat-value rate" id="first_showrate">--%</div>
                        <div class="appt-stat-label">Show Rate</div>
                    </div>
                </div>
                <div class="appt-results" id="first_results">
                    <div class="appt-results-header">
                        <span class="appt-results-title">Appointment Results</span>
                        <span class="appt-results-loading hidden" id="first_results_loading">Loading...</span>
                    </div>
                    <div class="appt-results-bars" id="first_results_bars"></div>
                </div>
            </div>
            <div class="appt-card">
                <div class="appt-title">2nd Appointments</div>
                <div class="appt-stats">
                    <div class="appt-stat">
                        <div class="appt-stat-value" id="second_booked">--</div>
                        <div class="appt-stat-label">Booked</div>
                    </div>
                    <div class="appt-stat">
                        <div class="appt-stat-value showed" id="second_showed">--</div>
                        <div class="appt-stat-label">Showed</div>
                    </div>
                    <div class="appt-stat">
                        <div class="appt-stat-value noshow" id="second_noshow">--</div>
                        <div class="appt-stat-label">No-Show</div>
                    </div>
                    <div class="appt-stat">
                        <div class="appt-stat-value rate" id="second_showrate">--%</div>
                        <div class="appt-stat-label">Show Rate</div>
                    </div>
                </div>
                <div class="appt-results" id="second_results">
                    <div class="appt-results-header">
                        <span class="appt-results-title">Appointment Results</span>
                        <span class="appt-results-loading hidden" id="second_results_loading">Loading...</span>
                    </div>
                    <div class="appt-results-bars" id="second_results_bars"></div>
                </div>
            </div>
        </div>

        <!-- Section 4: Cost Breakdown -->
        <div class="section-header" id="costHeader">Cost Breakdown (Last 30 Days)</div>
        <div class="cost-grid">
            <div class="cost-card">
                <div class="cost-label">SMS Cost</div>
                <div class="cost-value" id="costSms">$--</div>
                <div class="cost-detail" id="costSmsDetail">-- messages</div>
                <div class="cost-sub">90d avg: $<span id="costSms90">--</span>/day <span class="change" id="costSmsChg"></span></div>
            </div>
            <div class="cost-card">
                <div class="cost-label">Voice Cost (Twilio)</div>
                <div class="cost-value" id="costTwilioVoice">$--</div>
                <div class="cost-detail" id="costTwilioDetail">-- minutes</div>
                <div class="cost-sub">90d avg: $<span id="costTwilio90">--</span>/day <span class="change" id="costTwilioChg"></span></div>
            </div>
            <div class="cost-card">
                <div class="cost-label">AI Voice Cost (Retell)</div>
                <div class="cost-value" id="costRetell">$--</div>
                <div class="cost-detail" id="costRetellDetail">-- calls</div>
                <div class="cost-sub">90d avg: $<span id="costRetell90">--</span>/day <span class="change" id="costRetellChg"></span></div>
            </div>
            <div class="cost-card">
                <div class="cost-label">Total Cost</div>
                <div class="cost-value" id="costTotal">$--</div>
                <div class="cost-detail" id="costTotalDetail">all channels</div>
                <div class="cost-sub">90d avg: $<span id="costTotal90">--</span>/day <span class="change" id="costTotalChg"></span></div>
            </div>
            <div class="cost-card">
                <div class="cost-label">Cost / 1st Appt</div>
                <div class="cost-value" id="costPerAppt">$--</div>
                <div class="cost-detail" id="costPerApptDetail">per booking</div>
                <div class="cost-sub">90d avg: $<span id="costPerAppt90">--</span> <span class="change" id="costPerApptChg"></span></div>
            </div>
        </div>

        <!-- Section 5: Queue Status -->
        <div class="section-header" id="queueHeader">Outreach Queue (Today)</div>
        <div class="queue-grid">
            <div class="queue-card">
                <div class="queue-label">Total Queued</div>
                <div class="queue-value" style="color: var(--accent-cyan);" id="qTotal">--</div>
                <div class="queue-sub">scheduled today</div>
            </div>
            <div class="queue-card">
                <div class="queue-label">SMS Pending</div>
                <div class="queue-value" style="color: var(--accent-cyan);" id="qSmsPending">--</div>
                <div class="queue-sub">text messages</div>
            </div>
            <div class="queue-card">
                <div class="queue-label">Voice Pending</div>
                <div class="queue-value" style="color: var(--accent-purple);" id="qVoicePending">--</div>
                <div class="queue-sub">phone calls</div>
            </div>
            <div class="queue-card">
                <div class="queue-label">Sent Today</div>
                <div class="queue-value" style="color: var(--success-green);" id="qSent">--</div>
                <div class="queue-sub">delivered</div>
            </div>
            <div class="queue-card">
                <div class="queue-label">Failed Today</div>
                <div class="queue-value" style="color: var(--alert-red);" id="qFailed">--</div>
                <div class="queue-sub">errors</div>
            </div>
        </div>

        <!-- Section 6: Charts -->
        <div class="section-header">Charts</div>
        <div class="charts-grid">
            <div class="chart-card">
                <div class="chart-title">Queue by Channel (Today)</div>
                <div class="chart-container">
                    <canvas id="queueChartCanvas"></canvas>
                </div>
            </div>
            <div class="chart-card">
                <div class="chart-title" id="voiceChartTitle">Voice Call Outcomes</div>
                <div class="chart-container">
                    <canvas id="outcomesChartCanvas"></canvas>
                </div>
            </div>
        </div>
    </div>

    <div class="footer">
        KPI Dashboard v5.0 | Data: Supabase + GHL | Last updated: <span id="lastUpdated">--</span>
    </div>

    <script>
        // ============================================================
        // Configuration
        // ============================================================
        const SUPABASE_URL = 'https://saksbjogtkagedmlsrsv.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNha3Niam9ndGthZ2VkbWxzcnN2Iiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTc2OTI1NTEwMywiZXhwIjoyMDg0NjE1MTAzfQ.X7fHo2v_7HZBYZzggydteFbMh_y_pgQN78yynby5sI4';
        const GHL_STATS_URL = 'https://n8n.stopmyauctionnow.com/webhook/ghl-appointment-stats';
        const GHL_RESULTS_URL = 'https://n8n.stopmyauctionnow.com/webhook/ghl-appointment-results';
        const GHL_CAL_FIRST = 'gBD1ts4ZdRzWaMzti2Ck';
        const GHL_CAL_SECOND = 'WM8EhHF8mZjCPQAHXJxp';

        let sbClient;
        let queueChart, outcomesChart;

        // ============================================================
        // Initialization
        // ============================================================
        document.addEventListener('DOMContentLoaded', async () => {
            sbClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
            initCharts();
            await refreshData();
            setInterval(refreshData, 600000); // Auto-refresh every 10 min
        });

        function showLoading() { document.getElementById('loadingOverlay').classList.remove('hidden'); }
        function hideLoading() { document.getElementById('loadingOverlay').classList.add('hidden'); }

        // ============================================================
        // Date Range Helpers (Eastern Time)
        // ============================================================
        function formatEasternDate(date) {
            return new Intl.DateTimeFormat('en-CA', {
                timeZone: 'America/New_York',
                year: 'numeric', month: '2-digit', day: '2-digit'
            }).format(date);
        }

        function getDateRange() {
            const filter = document.getElementById('dateFilter').value;
            const now = new Date();
            const todayStr = formatEasternDate(now);
            let startDate, endDate, daysBack, startStr, endStr;

            endStr = todayStr;

            switch (filter) {
                case 'today':
                    startStr = todayStr;
                    startDate = new Date(todayStr + 'T00:00:00-05:00');
                    endDate = new Date(todayStr + 'T23:59:59-05:00');
                    daysBack = 1;
                    break;
                case '7d':
                    startDate = new Date(now - 7 * 86400000);
                    startStr = formatEasternDate(startDate);
                    endDate = now;
                    daysBack = 7;
                    break;
                case '90d':
                    startDate = new Date(now - 90 * 86400000);
                    startStr = formatEasternDate(startDate);
                    endDate = now;
                    daysBack = 90;
                    break;
                case '30d':
                    startDate = new Date(now - 30 * 86400000);
                    startStr = formatEasternDate(startDate);
                    endDate = now;
                    daysBack = 30;
                    break;
                default:
                    startDate = new Date(now - 7 * 86400000);
                    startStr = formatEasternDate(startDate);
                    endDate = now;
                    daysBack = 7;
            }

            // 90-day window for averages (always)
            const d90Start = new Date(now - 90 * 86400000);

            return {
                startISO: startDate.toISOString(),
                endISO: endDate.toISOString(),
                startStr, endStr, daysBack,
                d90StartISO: d90Start.toISOString(),
                d90StartStr: formatEasternDate(d90Start),
                label: filter === 'today' ? 'Today' : `Last ${daysBack} Days`
            };
        }

        // ============================================================
        // Supabase Helpers
        // ============================================================
        const SB_HEADERS = {
            'apikey': SUPABASE_KEY,
            'Authorization': `Bearer ${SUPABASE_KEY}`,
            'Content-Type': 'application/json'
        };

        async function sbCount(url, schema) {
            const headers = { ...SB_HEADERS, 'Prefer': 'count=exact' };
            if (schema) headers['Accept-Profile'] = schema;
            const resp = await fetch(url, { headers });
            if (!resp.ok) return 0;
            const range = resp.headers.get('Content-Range');
            if (range) {
                const m = range.match(/\/(\d+)$/);
                if (m) return parseInt(m[1], 10);
            }
            const data = await resp.json();
            return Array.isArray(data) ? data.length : 0;
        }

        async function sbFetch(url, schema) {
            const headers = { ...SB_HEADERS };
            if (schema) headers['Accept-Profile'] = schema;
            const resp = await fetch(url, { headers });
            if (!resp.ok) throw new Error(`Supabase ${resp.status}: ${resp.statusText}`);
            return resp.json();
        }

        // ============================================================
        // Chart Initialization
        // ============================================================
        function initCharts() {
            const chartColors = {
                gridColor: 'rgba(255,255,255,0.05)',
                tickColor: '#666',
                legendColor: '#888'
            };

            queueChart = new Chart(document.getElementById('queueChartCanvas').getContext('2d'), {
                type: 'bar',
                data: {
                    labels: ['SMS', 'Voice'],
                    datasets: [
                        { label: 'Queued', data: [0, 0], backgroundColor: 'rgba(255, 193, 7, 0.7)', borderRadius: 4 },
                        { label: 'Sent', data: [0, 0], backgroundColor: 'rgba(0, 200, 83, 0.7)', borderRadius: 4 },
                        { label: 'Failed', data: [0, 0], backgroundColor: 'rgba(196, 30, 58, 0.7)', borderRadius: 4 }
                    ]
                },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    plugins: { legend: { position: 'top', labels: { color: chartColors.legendColor, font: { size: 11 } } } },
                    scales: {
                        y: { beginAtZero: true, grid: { color: chartColors.gridColor }, ticks: { color: chartColors.tickColor } },
                        x: { grid: { display: false }, ticks: { color: chartColors.legendColor } }
                    }
                }
            });

            outcomesChart = new Chart(document.getElementById('outcomesChartCanvas').getContext('2d'), {
                type: 'doughnut',
                data: {
                    labels: ['Completed', 'Voicemail', 'Failed', 'Busy'],
                    datasets: [{ data: [0, 0, 0, 0], backgroundColor: ['#00c853', '#ffc107', '#c41e3a', '#ff8800'], borderWidth: 0 }]
                },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    plugins: { legend: { position: 'right', labels: { color: chartColors.legendColor, font: { size: 11 } } } }
                }
            });
        }

        // ============================================================
        // Main Refresh
        // ============================================================
        async function refreshData() {
            showLoading();
            const t0 = Date.now();
            const range = getDateRange();

            // Update section headers
            document.getElementById('kpiHeader').textContent = `Key Metrics (${range.label})`;
            document.getElementById('outreachHeader').textContent = `Outreach Volume (${range.label})`;
            document.getElementById('apptHeader').textContent = `Appointments (${range.label})`;

            const filter = document.getElementById('dateFilter').value;
            const costLabel = filter === 'today' ? 'Yesterday - Twilio updates nightly' : range.label;
            document.getElementById('costHeader').textContent = `Cost Breakdown (${costLabel})`;

            const todayDisplay = new Date().toLocaleDateString('en-US', {
                timeZone: 'America/New_York', month: 'numeric', day: 'numeric', year: 'numeric'
            });
            document.getElementById('queueHeader').textContent = `Outreach Queue ${todayDisplay}`;
            document.getElementById('outcomesTitle').textContent = `Voice Call Outcomes (${range.label})`;
            document.getElementById('voiceChartTitle').textContent = `Voice Call Outcomes (${range.label})`;

            // Shared state for cross-section calculations
            const state = { firstBooked: 0, totalSpend: 0, totalSpend90: 0, firstBooked90: 0 };

            try {
                const results = await Promise.allSettled([
                    fetchSMS(range, state),
                    fetchVoice(range, state),
                    fetchAppointments(range, state),
                    fetchCosts(range, state),
                    fetchQueue()
                ]);

                // After all fetches, calculate derived KPI cards
                updateDerivedKPIs(range, state);

                const labels = ['SMS', 'Voice', 'Appointments', 'Costs', 'Queue'];
                const fails = results.map((r, i) => r.status === 'rejected' ? labels[i] : null).filter(Boolean);
                const elapsed = Date.now() - t0;

                if (fails.length > 0) {
                    results.forEach((r, i) => { if (r.status === 'rejected') console.error(`[${labels[i]}]`, r.reason); });
                    document.getElementById('lastUpdated').textContent = new Date().toLocaleTimeString() + ` (${elapsed}ms) - ${fails.join(', ')} failed`;
                } else {
                    document.getElementById('lastUpdated').textContent = new Date().toLocaleTimeString() + ` (${elapsed}ms)`;
                }
            } catch (err) {
                console.error('Refresh error:', err);
                document.getElementById('lastUpdated').textContent = 'Error: ' + err.message;
            }

            hideLoading();
        }

        // ============================================================
        // Section 1 + 2: SMS Data (public.messages)
        // ============================================================
        async function fetchSMS(range, state) {
            const base = `${SUPABASE_URL}/rest/v1/messages`;

            // Current range counts
            const [sent, received, sent90, received90] = await Promise.all([
                sbCount(`${base}?channel=eq.sms&direction=eq.outbound&created_at=gte.${range.startISO}&created_at=lte.${range.endISO}&select=message_id`),
                sbCount(`${base}?channel=eq.sms&direction=eq.inbound&created_at=gte.${range.startISO}&created_at=lte.${range.endISO}&select=message_id`),
                sbCount(`${base}?channel=eq.sms&direction=eq.outbound&created_at=gte.${range.d90StartISO}&select=message_id`),
                sbCount(`${base}?channel=eq.sms&direction=eq.inbound&created_at=gte.${range.d90StartISO}&select=message_id`)
            ]);

            const respRate = sent > 0 ? (received / sent * 100) : 0;
            const respRate90 = sent90 > 0 ? (received90 / sent90 * 100) : 0;
            const sentDailyAvg = sent90 / 90;
            const recvDailyAvg = received90 / 90;
            const currentSentDaily = sent / range.daysBack;
            const currentRecvDaily = received / range.daysBack;

            // Section 2: SMS channel card
            setText('smsSent', sent.toLocaleString());
            setText('smsReceived', received.toLocaleString());
            setText('smsRespRate', respRate.toFixed(1) + '%');
            setText('smsSent90', sentDailyAvg.toFixed(0));
            setText('smsRecv90', recvDailyAvg.toFixed(0));
            setText('smsResp90', respRate90.toFixed(1));
            setChange('smsSentChg', currentSentDaily, sentDailyAvg);
            setChange('smsRecvChg', currentRecvDaily, recvDailyAvg);

            const badge = document.getElementById('smsRateBadge');
            badge.textContent = respRate.toFixed(1) + '%';
            badge.className = 'rate-badge ' + (respRate >= 15 ? 'good' : respRate >= 10 ? 'medium' : 'low');

            // Section 1: Response Rate KPI card
            setText('respRateVal', respRate.toFixed(1) + '%');
            setText('respRate90', respRate90.toFixed(1));
            setKPIChange('respRateChg', 'respRateInd', respRate - respRate90, false);
        }

        // ============================================================
        // Section 2: Voice Data (ops.retell_call_outcomes)
        // ============================================================
        async function fetchVoice(range, state) {
            const base = `${SUPABASE_URL}/rest/v1/retell_call_outcomes`;
            const selectFields = 'call_type,disconnection_reason,call_status,created_at';

            const [calls, calls90] = await Promise.all([
                sbFetch(`${base}?created_at=gte.${range.startISO}&created_at=lte.${range.endISO}&select=${selectFields}&limit=10000`, 'ops'),
                sbFetch(`${base}?created_at=gte.${range.d90StartISO}&select=${selectFields}&limit=10000`, 'ops')
            ]);

            // Current range
            const made = calls.filter(c => c.call_type !== 'inbound').length;
            let completed = 0, noAnswer = 0, failed = 0, busy = 0;
            calls.forEach(c => {
                const r = (c.disconnection_reason || '').toLowerCase();
                if (r === 'hangup' || r === 'user_hangup') completed++;
                else if (r === 'voicemail_reached' || r === 'no_valid_path' || r === 'agent_hangup') noAnswer++;
                else if (r === 'dial_failed') failed++;
                else if (r === 'dial_busy') busy++;
                else if (c.call_status === 'ended') completed++;
            });
            const answerRate = made > 0 ? (completed / made * 100) : 0;

            // 90-day
            const made90 = calls90.filter(c => c.call_type !== 'inbound').length;
            let completed90 = 0;
            calls90.forEach(c => {
                const r = (c.disconnection_reason || '').toLowerCase();
                if (r === 'hangup' || r === 'user_hangup' || c.call_status === 'ended') completed90++;
            });
            const answerRate90 = made90 > 0 ? (completed90 / made90 * 100) : 0;
            const madeDailyAvg = made90 / 90;
            const ansDailyAvg = completed90 / 90;
            const currentMadeDaily = made / range.daysBack;
            const currentAnsDaily = completed / range.daysBack;

            // Section 2: Voice channel card
            setText('voiceMade', made.toLocaleString());
            setText('voiceAnswered', completed.toLocaleString());
            setText('voiceAnsRate', answerRate.toFixed(1) + '%');
            setText('voiceMade90', madeDailyAvg.toFixed(0));
            setText('voiceAns90', ansDailyAvg.toFixed(0));
            setText('voiceAnsRate90', answerRate90.toFixed(1) + '%');
            setChange('voiceMadeChg', currentMadeDaily, madeDailyAvg);
            setChange('voiceAnsChg', currentAnsDaily, ansDailyAvg);

            const badge = document.getElementById('voiceRateBadge');
            badge.textContent = answerRate.toFixed(1) + '%';
            badge.className = 'rate-badge ' + (answerRate >= 40 ? 'good' : answerRate >= 25 ? 'medium' : 'low');

            // Outcomes boxes
            const total = calls.length;
            setText('outCompleted', completed.toLocaleString());
            setText('outVoicemail', noAnswer.toLocaleString());
            setText('outFailed', failed.toLocaleString());
            setText('outBusy', busy.toLocaleString());

            if (total > 0) {
                setText('outCompletedPct', (completed / total * 100).toFixed(1) + '%');
                setText('outVoicemailPct', (noAnswer / total * 100).toFixed(1) + '%');
                setText('outFailedPct', (failed / total * 100).toFixed(1) + '%');
                setText('outBusyPct', (busy / total * 100).toFixed(1) + '%');
                outcomesChart.data.datasets[0].data = [completed, noAnswer, failed, busy];
                outcomesChart.data.labels = ['Completed', 'Voicemail', 'Failed', 'Busy'];
                outcomesChart.data.datasets[0].backgroundColor = ['#00c853', '#ffc107', '#c41e3a', '#ff8800'];
            } else {
                setText('outCompletedPct', '--');
                setText('outVoicemailPct', '--');
                setText('outFailedPct', '--');
                setText('outBusyPct', '--');
                outcomesChart.data.datasets[0].data = [1];
                outcomesChart.data.labels = ['No calls yet'];
                outcomesChart.data.datasets[0].backgroundColor = ['#444'];
            }
            outcomesChart.update();
        }

        // ============================================================
        // Section 3: Appointments (GHL API via n8n webhook)
        // ============================================================
        async function fetchAppointments(range, state) {
            // Clear previous result breakdowns on each refresh
            const fb = document.getElementById('first_results_bars');
            const sb = document.getElementById('second_results_bars');
            if (fb) fb.innerHTML = '';
            if (sb) sb.innerHTML = '';

            // Fetch ALL appointment data from GHL via n8n webhook
            // Two parallel calls: current range + 90-day range
            let currentData = {}, ninetyData = {};
            try {
                const [currentResp, ninetyResp] = await Promise.all([
                    fetch(GHL_STATS_URL, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ startDate: range.startStr, endDate: range.endStr })
                    }),
                    fetch(GHL_STATS_URL, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ startDate: range.d90StartStr, endDate: range.endStr })
                    })
                ]);
                if (currentResp.ok) currentData = await currentResp.json();
                if (ninetyResp.ok) ninetyData = await ninetyResp.json();
            } catch (e) {
                console.warn('[Appointments] GHL webhook failed:', e.message);
            }

            // Current range stats
            const first = currentData.appointments?.first || {};
            const second = currentData.appointments?.second || {};
            const firstBooked = first.total || 0;
            const secondBooked = second.total || 0;
            const firstShowed = first.showed || 0;
            const firstNoshow = first.noshow || 0;
            const secondShowed = second.showed || 0;
            const secondNoshow = second.noshow || 0;

            // Show rate: showed / (showed + noshow)  excludes confirmed/cancelled (future appts)
            const firstResolved = firstShowed + firstNoshow;
            const secondResolved = secondShowed + secondNoshow;
            const firstShowRate = firstResolved > 0 ? (firstShowed / firstResolved * 100) : 0;
            const secondShowRate = secondResolved > 0 ? (secondShowed / secondResolved * 100) : 0;

            // 90-day stats for averages
            const first90 = ninetyData.appointments?.first || {};
            const second90 = ninetyData.appointments?.second || {};
            const firstBooked90 = first90.total || 0;
            const secondBooked90 = second90.total || 0;

            // Store for derived KPIs (Cost/1st Appt)
            state.firstBooked = firstBooked;
            state.firstBooked90 = firstBooked90;

            // Section 3: Appointment cards
            setText('first_booked', firstBooked);
            setText('first_showed', firstShowed);
            setText('first_noshow', firstNoshow);
            setText('first_showrate', firstShowRate.toFixed(0) + '%');
            setText('second_booked', secondBooked);
            setText('second_showed', secondShowed);
            setText('second_noshow', secondNoshow);
            setText('second_showrate', secondShowRate.toFixed(0) + '%');

            // Async result breakdown fetch (non-blocking, progressive enhancement)
            const firstShowedIds = first.showedIds || [];
            const secondShowedIds = second.showedIds || [];
            fetchAppointmentResults(firstShowedIds, 'first', 'first_results_bars', 'first_results_loading');
            fetchAppointmentResults(secondShowedIds, 'second', 'second_results_bars', 'second_results_loading');

            // Section 1: KPI cards for appointments
            const firstDailyAvg90 = firstBooked90 / 90;
            const secondDailyAvg90 = secondBooked90 / 90;
            const currentFirstDaily = firstBooked / range.daysBack;
            const currentSecondDaily = secondBooked / range.daysBack;

            setText('firstApptVal', firstBooked);
            setText('firstAppt90', firstDailyAvg90.toFixed(1));
            setKPIChange('firstApptChg', 'firstApptInd',
                firstDailyAvg90 > 0 ? ((currentFirstDaily - firstDailyAvg90) / firstDailyAvg90 * 100) : 0, true);

            setText('secondApptVal', secondBooked);
            setText('secondAppt90', secondDailyAvg90.toFixed(1));
            setKPIChange('secondApptChg', 'secondApptInd',
                secondDailyAvg90 > 0 ? ((currentSecondDaily - secondDailyAvg90) / secondDailyAvg90 * 100) : 0, true);
        }

        // ============================================================
        // Appointment Results Breakdown (async, progressive)
        // ============================================================
        const RESULT_LABEL_MAP = {
            'SHOWED: 2ND APPOINTMENT BOOKED': { label: '2nd Appt Booked', cls: 'second-booked' },
            'SHOWED: NURTURE':                { label: 'Nurture', cls: 'nurture' },
            'SHOWED: WRONG PERSON (DISQUALIFIED)': { label: 'Wrong Person', cls: 'disqualified' },
            'SHOWED: REFERRAL PROGRAM':       { label: 'Referral', cls: 'referral' },
            'SHOWED: DO NOT CONTACT':         { label: 'Do Not Contact', cls: 'dnc' },
            'SHOWED: HOT LEAD':              { label: 'Hot Lead', cls: 'hot-lead' },
            'SHOWED: PO SENT':               { label: 'PO Sent', cls: 'po-sent' },
            'SHOWED: DISQUALIFIED':          { label: 'Disqualified', cls: 'disqualified' },
            'NO SHOW':                        { label: 'No Show', cls: 'disqualified' }
        };

        async function fetchAppointmentResults(showedIds, calendarType, containerId, loadingId) {
            const loadingEl = document.getElementById(loadingId);
            const container = document.getElementById(containerId);
            if (!container) return;

            if (!showedIds || showedIds.length === 0) {
                if (loadingEl) loadingEl.classList.add('hidden');
                container.innerHTML = '<div class="appt-results-empty">No showed appointments in range</div>';
                return;
            }

            if (loadingEl) loadingEl.classList.remove('hidden');

            try {
                const resp = await fetch(GHL_RESULTS_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ appointmentIds: showedIds, calendarType })
                });
                if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
                const raw = await resp.json();
                const data = Array.isArray(raw) ? raw[0] : raw;
                if (loadingEl) loadingEl.classList.add('hidden');
                renderResultBars(container, data.results || {}, data.total || 0, data.capped || false, data.unmatched || 0);
            } catch (e) {
                console.warn(`[AppointmentResults:${calendarType}]`, e.message);
                if (loadingEl) loadingEl.classList.add('hidden');
                container.innerHTML = '<div class="appt-results-empty">Could not load results</div>';
            }
        }

        function renderResultBars(container, results, total, capped, unmatched) {
            const entries = Object.entries(results).sort((a, b) => b[1] - a[1]);

            if (entries.length === 0 && unmatched > 0) {
                container.innerHTML = `<div class="appt-results-empty">${unmatched} showed - results not yet recorded</div>`;
                return;
            }
            if (entries.length === 0) {
                container.innerHTML = '<div class="appt-results-empty">No results recorded yet</div>';
                return;
            }

            const maxCount = Math.max(...entries.map(e => e[1]));
            let html = '';
            for (const [rawLabel, count] of entries) {
                const mapped = RESULT_LABEL_MAP[rawLabel] || { label: rawLabel.replace('SHOWED: ', ''), cls: 'unknown-result' };
                const pct = maxCount > 0 ? (count / maxCount * 100) : 0;
                html += `<div class="result-row">
                    <span class="result-label" title="${rawLabel}">${mapped.label}</span>
                    <div class="result-bar-track">
                        <div class="result-bar-fill ${mapped.cls}" style="width: ${pct}%"></div>
                    </div>
                    <span class="result-count">${count}</span>
                </div>`;
            }
            if (unmatched > 0) {
                html += `<div class="result-row">
                    <span class="result-label">Not Recorded</span>
                    <div class="result-bar-track">
                        <div class="result-bar-fill unknown-result" style="width: ${maxCount > 0 ? (unmatched / maxCount * 100) : 0}%"></div>
                    </div>
                    <span class="result-count">${unmatched}</span>
                </div>`;
            }
            if (capped) {
                html += '<div class="appt-results-capped">Showing first 50 appointments only</div>';
            }
            container.innerHTML = html;
        }

        // ============================================================
        // Section 4: Costs (ops.twilio_daily_costs + ops.retell_call_outcomes)
        // ============================================================
        async function fetchCosts(range, state) {
            const filter = document.getElementById('dateFilter').value;

            // Twilio daily costs - uses date column (YYYY-MM-DD)
            // For "Today", show yesterday (complete data)
            let twStartDate = range.startStr;
            let twEndDate = range.endStr;
            if (filter === 'today') {
                const yesterday = new Date();
                yesterday.setDate(yesterday.getDate() - 1);
                twStartDate = formatEasternDate(yesterday);
                twEndDate = twStartDate;
            }

            const [twilioData, twilioData90, retellCostData, retellCost90Data] = await Promise.all([
                sbFetch(`${SUPABASE_URL}/rest/v1/twilio_daily_costs?date=gte.${twStartDate}&date=lte.${twEndDate}`, 'ops'),
                sbFetch(`${SUPABASE_URL}/rest/v1/twilio_daily_costs?date=gte.${range.d90StartStr}&date=lte.${range.endStr}`, 'ops'),
                sbFetch(`${SUPABASE_URL}/rest/v1/retell_call_outcomes?created_at=gte.${range.startISO}&created_at=lte.${range.endISO}&select=call_cost_cents&limit=10000`, 'ops'),
                sbFetch(`${SUPABASE_URL}/rest/v1/retell_call_outcomes?created_at=gte.${range.d90StartISO}&select=call_cost_cents&limit=10000`, 'ops')
            ]);

            // Current range costs
            let smsCost = 0, twilioVoiceCost = 0, smsCount = 0, callMinutes = 0;
            twilioData.forEach(d => {
                smsCost += parseFloat(d.sms_cost) || 0;
                twilioVoiceCost += parseFloat(d.call_cost) || 0;
                smsCount += (d.sms_outbound_count || 0) + (d.sms_inbound_count || 0);
                callMinutes += d.call_minutes || 0;
            });

            let retellCost = 0;
            retellCostData.forEach(d => { retellCost += (d.call_cost_cents || 0) / 100; });
            const retellCalls = retellCostData.length;

            const totalCost = smsCost + twilioVoiceCost + retellCost;

            // 90-day costs
            let smsCost90 = 0, twilioVoiceCost90 = 0;
            twilioData90.forEach(d => {
                smsCost90 += parseFloat(d.sms_cost) || 0;
                twilioVoiceCost90 += parseFloat(d.call_cost) || 0;
            });

            let retellCost90 = 0;
            retellCost90Data.forEach(d => { retellCost90 += (d.call_cost_cents || 0) / 100; });

            const totalCost90 = smsCost90 + twilioVoiceCost90 + retellCost90;

            // Store for derived KPIs
            state.totalSpend = totalCost;
            state.totalSpend90 = totalCost90;

            // Daily averages (90-day)
            const smsDailyAvg = smsCost90 / 90;
            const twilioDailyAvg = twilioVoiceCost90 / 90;
            const retellDailyAvg = retellCost90 / 90;
            const totalDailyAvg = totalCost90 / 90;

            // Current daily rate
            const days = filter === 'today' ? 1 : range.daysBack;
            const currentSmsDaily = smsCost / days;
            const currentTwilioDaily = twilioVoiceCost / days;
            const currentRetellDaily = retellCost / days;
            const currentTotalDaily = totalCost / days;

            // Section 4: Cost cards
            setText('costSms', '$' + smsCost.toFixed(2));
            setText('costSmsDetail', smsCount.toLocaleString() + ' messages');
            setText('costSms90', smsDailyAvg.toFixed(2));
            setCostChange('costSmsChg', currentSmsDaily, smsDailyAvg);

            setText('costTwilioVoice', '$' + twilioVoiceCost.toFixed(2));
            setText('costTwilioDetail', callMinutes.toLocaleString() + ' minutes');
            setText('costTwilio90', twilioDailyAvg.toFixed(2));
            setCostChange('costTwilioChg', currentTwilioDaily, twilioDailyAvg);

            setText('costRetell', '$' + retellCost.toFixed(2));
            setText('costRetellDetail', retellCalls.toLocaleString() + ' calls');
            setText('costRetell90', retellDailyAvg.toFixed(2));
            setCostChange('costRetellChg', currentRetellDaily, retellDailyAvg);

            setText('costTotal', '$' + totalCost.toFixed(2));
            setText('costTotalDetail', 'all channels');
            setText('costTotal90', totalDailyAvg.toFixed(2));
            setCostChange('costTotalChg', currentTotalDaily, totalDailyAvg);

            // Cost per 1st appointment (will use state.firstBooked after appointments load)
            // Handled in updateDerivedKPIs
        }

        // ============================================================
        // Section 5: Queue Status (always today)
        // ============================================================
        async function fetchQueue() {
            const todayStr = formatEasternDate(new Date());
            const todayStart = new Date(todayStr + 'T00:00:00-05:00');
            const tomorrowStart = new Date(todayStart.getTime() + 86400000);

            const { data: qData, error } = await sbClient
                .from('outreach_queue')
                .select('channel, status')
                .gte('next_action_at', todayStart.toISOString())
                .lt('next_action_at', tomorrowStart.toISOString());

            if (error) { console.warn('[Queue]', error.message); return; }

            const items = qData || [];
            const total = items.length;
            const smsPending = items.filter(q => q.channel === 'sms' && q.status === 'queued').length;
            const voicePending = items.filter(q => q.channel === 'voice' && q.status === 'queued').length;
            const sent = items.filter(q => q.status === 'sent').length;
            const failed = items.filter(q => q.status === 'failed').length;

            setText('qTotal', total.toLocaleString());
            setText('qSmsPending', smsPending.toLocaleString());
            setText('qVoicePending', voicePending.toLocaleString());
            setText('qSent', sent.toLocaleString());
            setText('qFailed', failed.toLocaleString());

            // Queue chart data
            const smsQueued = items.filter(q => q.channel === 'sms' && q.status === 'queued').length;
            const smsSent = items.filter(q => q.channel === 'sms' && q.status === 'sent').length;
            const smsFailed = items.filter(q => q.channel === 'sms' && q.status === 'failed').length;
            const voiceQueued = items.filter(q => q.channel === 'voice' && q.status === 'queued').length;
            const voiceSent = items.filter(q => q.channel === 'voice' && q.status === 'sent').length;
            const voiceFailed = items.filter(q => q.channel === 'voice' && q.status === 'failed').length;

            queueChart.data.datasets[0].data = [smsQueued, voiceQueued];
            queueChart.data.datasets[1].data = [smsSent, voiceSent];
            queueChart.data.datasets[2].data = [smsFailed, voiceFailed];
            queueChart.update();
        }

        // ============================================================
        // Derived KPIs (after all fetches complete)
        // ============================================================
        function updateDerivedKPIs(range, state) {
            // Total Spend KPI card
            const totalDailyAvg = state.totalSpend90 / 90;
            const currentTotalDaily = state.totalSpend / range.daysBack;

            setText('totalSpendVal', '$' + state.totalSpend.toFixed(2));
            setText('totalSpend90', totalDailyAvg.toFixed(2));
            // For costs, lower is better - invert the indicator
            const spendPctChange = totalDailyAvg > 0 ? ((currentTotalDaily - totalDailyAvg) / totalDailyAvg * 100) : 0;
            setKPIChangeCost('totalSpendChg', 'totalSpendInd', spendPctChange);

            // Cost per 1st Appointment KPI card
            const cpa = state.firstBooked > 0 ? (state.totalSpend / state.firstBooked) : 0;
            const cpa90 = state.firstBooked90 > 0 ? (state.totalSpend90 / state.firstBooked90) : 0;

            setText('cpaVal', cpa > 0 ? '$' + cpa.toFixed(2) : '$--');
            setText('cpa90', cpa90 > 0 ? cpa90.toFixed(2) : '--');
            if (cpa > 0 && cpa90 > 0) {
                const cpaPctChange = ((cpa - cpa90) / cpa90 * 100);
                setKPIChangeCost('cpaChg', 'cpaInd', cpaPctChange);
            } else {
                setText('cpaChg', '--');
                setClass('cpaChg', 'kpi-change neutral');
                setClass('cpaInd', 'kpi-indicator warning');
            }

            // Cost per 1st Appt in Section 4
            setText('costPerAppt', cpa > 0 ? '$' + cpa.toFixed(2) : '$--');
            setText('costPerApptDetail', state.firstBooked > 0 ? state.firstBooked + ' bookings' : 'no bookings');
            setText('costPerAppt90', cpa90 > 0 ? cpa90.toFixed(2) : '--');
            if (cpa > 0 && cpa90 > 0) {
                setCostChange('costPerApptChg', cpa, cpa90);
            }
        }

        // ============================================================
        // UI Helpers
        // ============================================================
        function setText(id, text) {
            const el = document.getElementById(id);
            if (el) el.textContent = text;
        }

        function setClass(id, cls) {
            const el = document.getElementById(id);
            if (el) el.className = cls;
        }

        // Change indicator for count metrics (higher = better)
        function setChange(id, current, avg) {
            const el = document.getElementById(id);
            if (!el) return;
            if (avg > 0) {
                const pct = ((current - avg) / avg * 100);
                el.textContent = (pct >= 0 ? '+' : '') + pct.toFixed(0) + '%';
                el.className = 'change ' + (pct >= 0 ? 'up' : 'down');
            } else {
                el.textContent = '--';
                el.className = 'change';
            }
        }

        // Change indicator for cost metrics (lower = better)
        function setCostChange(id, current, avg) {
            const el = document.getElementById(id);
            if (!el) return;
            if (avg > 0) {
                const pct = ((current - avg) / avg * 100);
                el.textContent = (pct >= 0 ? '+' : '') + pct.toFixed(0) + '%';
                el.className = 'change ' + (pct <= 0 ? 'cost-down' : 'cost-up');
            } else {
                el.textContent = '--';
                el.className = 'change';
            }
        }

        // KPI card change + indicator (higher = better)
        function setKPIChange(changeId, indId, pctChange, isPercent) {
            const changeEl = document.getElementById(changeId);
            const indEl = document.getElementById(indId);
            if (!changeEl) return;

            if (isPercent) {
                changeEl.textContent = (pctChange >= 0 ? '+' : '') + pctChange.toFixed(0) + '%';
                changeEl.className = 'kpi-change ' + (pctChange >= 0 ? 'up' : 'down');
            } else {
                // For ratio diffs (percentage points)
                changeEl.textContent = (pctChange >= 0 ? '+' : '') + pctChange.toFixed(1) + 'pp';
                changeEl.className = 'kpi-change ' + (pctChange >= 0 ? 'up' : 'down');
            }

            if (indEl) {
                const absPct = Math.abs(pctChange);
                indEl.className = 'kpi-indicator ' + (pctChange >= -5 ? 'good' : pctChange >= -20 ? 'warning' : 'alert');
            }
        }

        // KPI card change + indicator for costs (lower = better)
        function setKPIChangeCost(changeId, indId, pctChange) {
            const changeEl = document.getElementById(changeId);
            const indEl = document.getElementById(indId);
            if (!changeEl) return;

            changeEl.textContent = (pctChange >= 0 ? '+' : '') + pctChange.toFixed(0) + '%';
            // For costs: negative change = good (costs went down)
            changeEl.className = 'kpi-change ' + (pctChange <= 0 ? 'cost-down' : 'cost-up');

            if (indEl) {
                indEl.className = 'kpi-indicator ' + (pctChange <= 10 ? 'good' : pctChange <= 25 ? 'warning' : 'alert');
            }
        }
    </script>
</body>
</html>
