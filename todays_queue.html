<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Outreach Mission Control</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&family=Roboto+Mono:wght@400;500&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --bg-primary: #0b0b0f;
            --bg-secondary: #1a1a1e;
            --bg-panel: #141418;
            --bg-hover: #252529;
            --accent-cyan: #00bcd4;
            --accent-blue: #005288;
            --alert-red: #c41e3a;
            --success-green: #00c853;
            --warning-yellow: #ffc107;
            --warning-orange: #ff8800;
            --text-primary: #ffffff;
            --text-secondary: #9e9e9e;
            --text-muted: #666;
            --border-color: #2a2a2e;
            --sms-color: #00c853;
            --voice-color: #ab47bc;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Roboto', sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
        }

        /* Header */
        header {
            position: sticky; top: 0; z-index: 100;
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border-color);
            padding: 12px 24px;
            display: flex; justify-content: space-between; align-items: center;
        }
        header h1 { font-size: 18px; font-weight: 500; letter-spacing: 1px; }
        .header-right { display: flex; align-items: center; gap: 12px; }
        .refresh-btn {
            background: var(--accent-cyan); color: #000;
            border: none; padding: 6px 16px; border-radius: 4px;
            font-weight: 500; cursor: pointer; font-size: 13px;
        }
        .refresh-btn:hover { opacity: 0.85; }
        .auto-refresh-label { font-size: 12px; color: var(--text-muted); font-family: 'Roboto Mono', monospace; }
        .last-updated { font-size: 12px; color: var(--text-secondary); }

        main { padding: 16px 24px; max-width: 1400px; margin: 0 auto; }

        /* ── Section 1: Progress Bar ── */
        .progress-section {
            background: var(--bg-panel); border: 1px solid var(--border-color);
            border-radius: 8px; padding: 20px 24px; margin-bottom: 16px;
        }
        .progress-header {
            display: flex; justify-content: space-between; align-items: baseline;
            margin-bottom: 12px;
        }
        .progress-header h2 { font-size: 14px; font-weight: 400; color: var(--text-secondary); text-transform: uppercase; letter-spacing: 1px; }
        .progress-time { font-size: 13px; color: var(--text-muted); font-family: 'Roboto Mono', monospace; }
        .progress-stats {
            display: flex; align-items: baseline; gap: 12px; margin-bottom: 8px;
        }
        .progress-count { font-size: 32px; font-weight: 700; font-family: 'Roboto Mono', monospace; }
        .progress-total { font-size: 18px; color: var(--text-muted); font-family: 'Roboto Mono', monospace; }
        .progress-pct { font-size: 14px; color: var(--accent-cyan); font-family: 'Roboto Mono', monospace; }
        .progress-eta { font-size: 13px; color: var(--text-secondary); margin-left: auto; }
        .progress-bar-container {
            background: var(--bg-secondary); border-radius: 6px; height: 28px;
            overflow: hidden; position: relative; margin-bottom: 12px;
        }
        .progress-bar-fill {
            height: 100%; display: flex; transition: width 0.6s ease;
        }
        .progress-bar-sms { background: var(--sms-color); }
        .progress-bar-voice { background: var(--voice-color); }
        .progress-bar-label {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            font-size: 12px; font-weight: 500; color: #fff;
            text-shadow: 0 1px 3px rgba(0,0,0,0.7);
            font-family: 'Roboto Mono', monospace;
        }
        .channel-bars {
            display: flex; gap: 24px;
        }
        .channel-bar-item { flex: 1; }
        .channel-bar-label {
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 4px; font-size: 12px;
        }
        .channel-bar-label span:first-child { font-weight: 500; }
        .channel-bar-label .counts { color: var(--text-muted); font-family: 'Roboto Mono', monospace; }
        .channel-mini-bar {
            background: var(--bg-secondary); border-radius: 3px; height: 8px; overflow: hidden;
        }
        .channel-mini-bar-fill { height: 100%; border-radius: 3px; transition: width 0.6s ease; }

        /* ── Section 2: KPI Cards ── */
        .kpi-grid {
            display: grid; grid-template-columns: repeat(4, 1fr);
            gap: 12px; margin-bottom: 16px;
        }
        .kpi-card {
            background: var(--bg-panel); border: 1px solid var(--border-color);
            border-radius: 8px; padding: 16px 20px;
        }
        .kpi-label { font-size: 11px; color: var(--text-muted); text-transform: uppercase; letter-spacing: 1px; margin-bottom: 6px; }
        .kpi-value {
            font-size: 28px; font-weight: 700; font-family: 'Roboto Mono', monospace;
            line-height: 1.1; margin-bottom: 4px;
        }
        .kpi-sub { font-size: 12px; color: var(--text-secondary); }
        .kpi-value.green { color: var(--success-green); }
        .kpi-value.cyan { color: var(--accent-cyan); }
        .kpi-value.yellow { color: var(--warning-yellow); }
        .kpi-value.red { color: var(--alert-red); }
        .health-dot {
            display: inline-block; width: 10px; height: 10px;
            border-radius: 50%; margin-right: 6px; vertical-align: middle;
        }
        .health-dot.green { background: var(--success-green); box-shadow: 0 0 6px var(--success-green); }
        .health-dot.yellow { background: var(--warning-yellow); box-shadow: 0 0 6px var(--warning-yellow); }
        .health-dot.red { background: var(--alert-red); box-shadow: 0 0 6px var(--alert-red); animation: pulse 1.5s infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }

        /* ── Section 3 & 5: Two-column layout ── */
        .two-col {
            display: grid; grid-template-columns: 2fr 1fr;
            gap: 16px; margin-bottom: 16px;
        }
        .panel {
            background: var(--bg-panel); border: 1px solid var(--border-color);
            border-radius: 8px; padding: 16px 20px;
        }
        .panel-title {
            font-size: 13px; font-weight: 500; color: var(--text-secondary);
            text-transform: uppercase; letter-spacing: 1px; margin-bottom: 12px;
        }

        /* ── Section 4: Health Panel ── */
        .health-grid {
            display: grid; grid-template-columns: 1fr 1fr 1fr;
            gap: 8px;
        }
        .health-item {
            background: var(--bg-secondary); border-radius: 6px;
            padding: 10px 14px;
        }
        .health-item-label { font-size: 11px; color: var(--text-muted); text-transform: uppercase; margin-bottom: 4px; }
        .health-item-value { font-size: 16px; font-weight: 500; font-family: 'Roboto Mono', monospace; }
        .health-item-detail { font-size: 11px; color: var(--text-muted); margin-top: 2px; }

        /* ── Section 5: Comparison table ── */
        .compare-table { width: 100%; border-collapse: collapse; }
        .compare-table th {
            text-align: left; font-size: 11px; color: var(--text-muted);
            text-transform: uppercase; padding: 6px 0; border-bottom: 1px solid var(--border-color);
        }
        .compare-table td {
            padding: 6px 0; font-family: 'Roboto Mono', monospace; font-size: 14px;
        }
        .compare-table tr:not(:last-child) td { border-bottom: 1px solid rgba(255,255,255,0.04); }
        .compare-table .metric-name { font-family: 'Roboto', sans-serif; color: var(--text-secondary); font-size: 13px; }
        .compare-table .yesterday { color: var(--text-muted); }

        /* ── Section 6: Tabs + Aggregate Tables ── */
        .tabs { display: flex; gap: 4px; margin-bottom: 12px; flex-wrap: wrap; }
        .tab-btn {
            background: var(--bg-secondary); border: 1px solid var(--border-color);
            color: var(--text-secondary); padding: 6px 14px; border-radius: 4px;
            font-size: 12px; cursor: pointer; font-family: 'Roboto', sans-serif;
        }
        .tab-btn.active { background: var(--accent-cyan); color: #000; border-color: var(--accent-cyan); font-weight: 500; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .agg-table { width: 100%; border-collapse: collapse; }
        .agg-table th {
            text-align: left; font-size: 11px; color: var(--text-muted);
            text-transform: uppercase; padding: 8px 12px;
            border-bottom: 1px solid var(--border-color);
        }
        .agg-table th:not(:first-child) { text-align: right; }
        .agg-table td {
            padding: 8px 12px; font-family: 'Roboto Mono', monospace; font-size: 13px;
            border-bottom: 1px solid rgba(255,255,255,0.04);
        }
        .agg-table td:not(:first-child) { text-align: right; }
        .agg-table td:first-child { font-family: 'Roboto', sans-serif; color: var(--text-secondary); }
        .agg-table tr:hover { background: var(--bg-hover); }
        .bar-cell { display: flex; align-items: center; gap: 8px; justify-content: flex-end; }
        .mini-bar { height: 6px; border-radius: 3px; min-width: 2px; }

        /* Responsive */
        @media (max-width: 900px) {
            .kpi-grid { grid-template-columns: repeat(2, 1fr); }
            .two-col { grid-template-columns: 1fr; }
            .health-grid { grid-template-columns: 1fr 1fr; }
        }
        @media (max-width: 480px) {
            main { padding: 12px; }
            .kpi-grid { grid-template-columns: 1fr 1fr; }
            .channel-bars { flex-direction: column; gap: 8px; }
        }
    </style>
</head>
<body>

<header>
    <h1>Outreach Mission Control</h1>
    <div class="header-right">
        <span class="last-updated" id="lastUpdated"></span>
        <span class="auto-refresh-label" id="countdown"></span>
        <button class="refresh-btn" onclick="loadAll()">Refresh</button>
    </div>
</header>

<main>
    <!-- Section 1: Progress Bar -->
    <div class="progress-section">
        <div class="progress-header">
            <h2>Today's Outreach</h2>
            <span class="progress-time" id="opWindow">8:00 AM &ndash; 8:00 PM EST</span>
        </div>
        <div class="progress-stats">
            <span class="progress-count" id="sentCount">--</span>
            <span class="progress-total" id="totalTarget">/ --</span>
            <span class="progress-pct" id="pctDone"></span>
            <span class="progress-eta" id="etaLabel"></span>
        </div>
        <div class="progress-bar-container">
            <div class="progress-bar-fill" id="progressFill">
                <div class="progress-bar-sms" id="progressSms" style="width:0"></div>
                <div class="progress-bar-voice" id="progressVoice" style="width:0"></div>
            </div>
            <span class="progress-bar-label" id="progressLabel"></span>
        </div>
        <div class="channel-bars">
            <div class="channel-bar-item">
                <div class="channel-bar-label">
                    <span style="color:var(--sms-color)">SMS</span>
                    <span class="counts" id="smsCounts">--</span>
                </div>
                <div class="channel-mini-bar">
                    <div class="channel-mini-bar-fill" id="smsBar" style="width:0;background:var(--sms-color)"></div>
                </div>
            </div>
            <div class="channel-bar-item">
                <div class="channel-bar-label">
                    <span style="color:var(--voice-color)">Voice</span>
                    <span class="counts" id="voiceCounts">--</span>
                </div>
                <div class="channel-mini-bar">
                    <div class="channel-mini-bar-fill" id="voiceBar" style="width:0;background:var(--voice-color)"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Section 2: KPI Cards -->
    <div class="kpi-grid">
        <div class="kpi-card">
            <div class="kpi-label">Eligible</div>
            <div class="kpi-value cyan" id="kpiEligible">--</div>
            <div class="kpi-sub" id="kpiEligibleSub"></div>
        </div>
        <div class="kpi-card">
            <div class="kpi-label">Sent Today</div>
            <div class="kpi-value green" id="kpiSent">--</div>
            <div class="kpi-sub" id="kpiSentSub"></div>
        </div>
        <div class="kpi-card">
            <div class="kpi-label">Throughput</div>
            <div class="kpi-value" id="kpiThroughput">--</div>
            <div class="kpi-sub" id="kpiThroughputSub"></div>
        </div>
        <div class="kpi-card">
            <div class="kpi-label">Health</div>
            <div class="kpi-value" id="kpiHealth">--</div>
            <div class="kpi-sub" id="kpiHealthSub"></div>
        </div>
    </div>

    <!-- Section 3 (chart) + Section 4 (health) side by side -->
    <div class="two-col">
        <div class="panel">
            <div class="panel-title">Hourly Sends (Actual)</div>
            <div style="position:relative;height:220px"><canvas id="hourlyChart"></canvas></div>
        </div>
        <div class="panel">
            <div class="panel-title">Pipeline Health</div>
            <div class="health-grid" id="healthGrid"></div>
        </div>
    </div>

    <!-- Section 5: Yesterday vs Today -->
    <div class="panel" style="margin-bottom:16px">
        <div class="panel-title">Yesterday vs Today</div>
        <table class="compare-table" id="compareTable"></table>
    </div>

    <!-- Section 6: Aggregate Breakdown -->
    <div class="panel">
        <div class="panel-title">Queue Breakdown</div>
        <div class="tabs" id="aggTabs"></div>
        <div id="aggContent"></div>
    </div>
</main>

<script>
// ============================================================
//  CONFIG
// ============================================================
const SUPABASE_URL = 'https://saksbjogtkagedmlsrsv.supabase.co';
const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNha3Niam9ndGthZ2VkbWxzcnN2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjkyNTUxMDMsImV4cCI6MjA4NDYxNTEwM30.FvfTxotEWZlkmQNiekbt4KyxvDk_7GBqfWn55pKTjho';
const HEADERS = {
    'apikey': SUPABASE_KEY,
    'Authorization': `Bearer ${SUPABASE_KEY}`,
    'Content-Type': 'application/json'
};
const REFRESH_INTERVAL = 60; // seconds

// ============================================================
//  TIME HELPERS (EST)
// ============================================================
function nowEST() {
    return new Date(new Date().toLocaleString('en-US', { timeZone: 'America/New_York' }));
}
function todayBoundsUTC() {
    const n = nowEST();
    const y = n.getFullYear(), m = n.getMonth(), d = n.getDate();
    // 8am EST = 13:00 UTC (EST is -5)
    const offset = isDST(n) ? 4 : 5;
    const start = new Date(Date.UTC(y, m, d, 8 + offset, 0, 0));    // 8am EST
    const end   = new Date(Date.UTC(y, m, d, 20 + offset, 0, 0));   // 8pm EST
    const midnight = new Date(Date.UTC(y, m, d, offset, 0, 0));     // midnight EST
    return { start, end, midnight };
}
function yesterdayBoundsUTC() {
    const n = nowEST();
    const y = n.getFullYear(), m = n.getMonth(), d = n.getDate() - 1;
    const offset = isDST(n) ? 4 : 5;
    const start = new Date(Date.UTC(y, m, d, 8 + offset, 0, 0));
    const end   = new Date(Date.UTC(y, m, d, 20 + offset, 0, 0));
    return { start, end };
}
function isDST(d) {
    const jan = new Date(d.getFullYear(), 0, 1).getTimezoneOffset();
    const jul = new Date(d.getFullYear(), 6, 1).getTimezoneOffset();
    return d.getTimezoneOffset() < Math.max(jan, jul);
}
function fmtTime(d) {
    return d.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit', hour12: true, timeZone: 'America/New_York' });
}
function fmtNum(n) { return n == null ? '--' : n.toLocaleString(); }

// ============================================================
//  SUPABASE HELPERS
// ============================================================
async function sbCount(table, params = '') {
    const r = await fetch(`${SUPABASE_URL}/rest/v1/${table}?select=queue_id&limit=1${params ? '&' + params : ''}`, {
        headers: { ...HEADERS, 'Prefer': 'count=exact' }
    });
    const cr = r.headers.get('content-range') || '*/0';
    return parseInt(cr.split('/').pop()) || 0;
}

async function sbFetch(table, params = '', extra = {}) {
    const allRows = [];
    let offset = 0;
    const limit = 5000;
    while (true) {
        const url = `${SUPABASE_URL}/rest/v1/${table}?${params}&limit=${limit}&offset=${offset}`;
        const r = await fetch(url, { headers: { ...HEADERS, ...extra } });
        if (!r.ok && r.status !== 206) break;
        const data = await r.json();
        if (!data.length) break;
        allRows.push(...data);
        if (data.length < limit) break;
        offset += limit;
    }
    return allRows;
}

// ============================================================
//  STATE
// ============================================================
let hourlyChart = null;
let countdownTimer = null;
let secondsLeft = REFRESH_INTERVAL;

// ============================================================
//  MAIN LOAD
// ============================================================
async function loadAll() {
    const t0 = performance.now();
    document.getElementById('lastUpdated').textContent = 'Loading...';
    secondsLeft = REFRESH_INTERVAL;

    try {
        const bounds = todayBoundsUTC();
        const yBounds = yesterdayBoundsUTC();
        const startISO = bounds.start.toISOString();
        const endISO = bounds.end.toISOString();
        const midnightISO = bounds.midnight.toISOString();
        const yStartISO = yBounds.start.toISOString();
        const yEndISO = yBounds.end.toISOString();

        // Parallel fetch everything
        const [
            queuedTotal,
            queuedToday,
            sentTodayItems,
            failedToday,
            stuckCount,
            backlogCount,
            backlogOldest,
            yesterdaySent,
            yesterdayFailed,
            queuedItems
        ] = await Promise.all([
            sbCount('outreach_queue', 'status=eq.queued'),
            sbCount('outreach_queue', `status=eq.queued&and=(next_action_at.gte.${midnightISO},next_action_at.lt.${bounds.end.toISOString()})`),
            sbFetch('outreach_queue', `select=channel,updated_at,template_key,meta&status=eq.sent&updated_at=gte.${startISO}&updated_at=lt.${endISO}`),
            sbCount('outreach_queue', `status=eq.failed&updated_at=gte.${startISO}`),
            sbCount('outreach_queue', `status=eq.in_progress&updated_at=lt.${new Date(Date.now() - 30 * 60000).toISOString()}`),
            sbCount('outreach_queue', `status=eq.queued&next_action_at=lt.${midnightISO}`),
            sbFetch('outreach_queue', `select=next_action_at&status=eq.queued&next_action_at=lt.${midnightISO}&order=next_action_at.asc&limit=1`),
            sbFetch('outreach_queue', `select=channel&status=eq.sent&updated_at=gte.${yStartISO}&updated_at=lt.${yEndISO}`),
            sbCount('outreach_queue', `status=eq.failed&updated_at=gte.${yStartISO}&updated_at=lt.${yEndISO}`),
            sbFetch('outreach_queue', `select=channel,template_key,meta&status=eq.queued`),
        ]);

        // ── Derive metrics ──
        const sentToday = sentTodayItems.length;
        const smsSent = sentTodayItems.filter(r => r.channel === 'sms').length;
        const voiceSent = sentTodayItems.filter(r => r.channel === 'voice').length;

        const totalTarget = queuedTotal + sentToday;
        const pct = totalTarget > 0 ? Math.round(sentToday / totalTarget * 100) : 0;

        // Throughput: items sent in last 60 min
        const oneHourAgo = new Date(Date.now() - 3600000).toISOString();
        const sentLastHour = sentTodayItems.filter(r => r.updated_at >= oneHourAgo).length;
        const throughputHr = sentLastHour;

        // ETA
        let etaText = '';
        const est = nowEST();
        const currentHour = est.getHours();
        if (currentHour < 8) {
            etaText = 'Starts at 8:00 AM';
        } else if (currentHour >= 20) {
            etaText = 'Window closed';
        } else if (throughputHr > 0 && queuedTotal > 0) {
            const hoursLeft = queuedTotal / throughputHr;
            const etaDate = new Date(Date.now() + hoursLeft * 3600000);
            const etaEST = new Date(etaDate.toLocaleString('en-US', { timeZone: 'America/New_York' }));
            if (etaEST.getHours() >= 20) {
                etaText = 'Extends past 8 PM';
            } else {
                etaText = `ETA: ${fmtTime(etaDate)}`;
            }
        } else if (sentToday === 0 && currentHour >= 8) {
            etaText = 'Waiting for first send...';
        }

        // ── Section 1: Progress ──
        document.getElementById('sentCount').textContent = fmtNum(sentToday);
        document.getElementById('totalTarget').textContent = `/ ${fmtNum(totalTarget)}`;
        document.getElementById('pctDone').textContent = `${pct}%`;
        document.getElementById('etaLabel').textContent = etaText;

        const barTotal = Math.max(totalTarget, 1);
        const smsPct = smsSent / barTotal * 100;
        const voicePct = voiceSent / barTotal * 100;
        document.getElementById('progressSms').style.width = smsPct + '%';
        document.getElementById('progressVoice').style.width = voicePct + '%';
        document.getElementById('progressLabel').textContent = `${pct}%`;

        const smsTarget = Math.round(totalTarget / 2);
        const voiceTarget = totalTarget - smsTarget;
        document.getElementById('smsCounts').textContent = `${fmtNum(smsSent)} / ${fmtNum(smsTarget)}`;
        document.getElementById('voiceCounts').textContent = `${fmtNum(voiceSent)} / ${fmtNum(voiceTarget)}`;
        document.getElementById('smsBar').style.width = (smsTarget > 0 ? Math.min(smsSent / smsTarget * 100, 100) : 0) + '%';
        document.getElementById('voiceBar').style.width = (voiceTarget > 0 ? Math.min(voiceSent / voiceTarget * 100, 100) : 0) + '%';

        // ── Section 2: KPI Cards ──
        document.getElementById('kpiEligible').textContent = fmtNum(queuedTotal);
        const backlogLabel = backlogCount > 0 ? `${fmtNum(queuedToday)} new + ${fmtNum(backlogCount)} backlog` : `${fmtNum(queuedToday)} scheduled today`;
        document.getElementById('kpiEligibleSub').textContent = backlogLabel;

        document.getElementById('kpiSent').textContent = fmtNum(sentToday);
        document.getElementById('kpiSentSub').textContent = `${fmtNum(smsSent)} SMS + ${fmtNum(voiceSent)} Voice`;

        document.getElementById('kpiThroughput').textContent = throughputHr > 0 ? `${fmtNum(throughputHr)}/hr` : '--';
        document.getElementById('kpiThroughput').className = 'kpi-value' + (throughputHr > 200 ? '' : throughputHr > 0 ? ' yellow' : '');
        document.getElementById('kpiThroughputSub').textContent = throughputHr > 0 ? `~${Math.round(throughputHr / 60)}/min` : 'No sends yet';

        // Health
        const errorRate = sentToday > 0 ? (failedToday / (sentToday + failedToday) * 100) : 0;
        let healthColor = 'green', healthText = 'Healthy';
        if (stuckCount > 5 || errorRate > 5) { healthColor = 'red'; healthText = 'Issues'; }
        else if (stuckCount > 0 || errorRate > 1 || failedToday > 5) { healthColor = 'yellow'; healthText = 'Warning'; }

        document.getElementById('kpiHealth').innerHTML = `<span class="health-dot ${healthColor}"></span>${healthText}`;
        document.getElementById('kpiHealth').className = 'kpi-value';
        const healthParts = [];
        if (stuckCount > 0) healthParts.push(`${stuckCount} stuck`);
        if (failedToday > 0) healthParts.push(`${failedToday} failed`);
        if (!healthParts.length) healthParts.push('No issues');
        document.getElementById('kpiHealthSub').textContent = healthParts.join(', ');

        // ── Section 3: Hourly Chart ──
        updateHourlyChart(sentTodayItems);

        // ── Section 4: Health Panel ──
        const oldestDate = backlogOldest.length > 0 ? new Date(backlogOldest[0].next_action_at).toLocaleDateString('en-US', { month: 'short', day: 'numeric', timeZone: 'America/New_York' }) : 'N/A';
        document.getElementById('healthGrid').innerHTML = `
            <div class="health-item">
                <div class="health-item-label">Stuck</div>
                <div class="health-item-value" style="color:${stuckCount === 0 ? 'var(--success-green)' : 'var(--alert-red)'}">${stuckCount}</div>
                <div class="health-item-detail">in_progress > 30m</div>
            </div>
            <div class="health-item">
                <div class="health-item-label">Failed</div>
                <div class="health-item-value" style="color:${failedToday === 0 ? 'var(--success-green)' : 'var(--warning-yellow)'}">${failedToday}</div>
                <div class="health-item-detail">today</div>
            </div>
            <div class="health-item">
                <div class="health-item-label">Error Rate</div>
                <div class="health-item-value" style="color:${errorRate < 1 ? 'var(--success-green)' : 'var(--warning-yellow)'}">${errorRate.toFixed(1)}%</div>
                <div class="health-item-detail">failed / total</div>
            </div>
            <div class="health-item">
                <div class="health-item-label">Backlog</div>
                <div class="health-item-value" style="color:${backlogCount === 0 ? 'var(--success-green)' : 'var(--warning-orange)'}">${fmtNum(backlogCount)}</div>
                <div class="health-item-detail">${backlogCount > 0 ? 'since ' + oldestDate : 'none'}</div>
            </div>
            <div class="health-item">
                <div class="health-item-label">Queued</div>
                <div class="health-item-value">${fmtNum(queuedTotal)}</div>
                <div class="health-item-detail">remaining</div>
            </div>
            <div class="health-item">
                <div class="health-item-label">Capacity</div>
                <div class="health-item-value">${throughputHr > 0 ? fmtNum(Math.round(throughputHr * 12)) + '/day' : '--'}</div>
                <div class="health-item-detail">based on actual rate</div>
            </div>
        `;

        // ── Section 5: Yesterday vs Today ──
        const ySent = yesterdaySent.length;
        const ySmsSent = yesterdaySent.filter(r => r.channel === 'sms').length;
        const yVoiceSent = yesterdaySent.filter(r => r.channel === 'voice').length;

        document.getElementById('compareTable').innerHTML = `
            <tr><th class="metric-name"></th><th>Yesterday</th><th>Today</th></tr>
            <tr><td class="metric-name">Total Sent</td><td class="yesterday">${fmtNum(ySent)}</td><td>${fmtNum(sentToday)}</td></tr>
            <tr><td class="metric-name">SMS</td><td class="yesterday">${fmtNum(ySmsSent)}</td><td style="color:var(--sms-color)">${fmtNum(smsSent)}</td></tr>
            <tr><td class="metric-name">Voice</td><td class="yesterday">${fmtNum(yVoiceSent)}</td><td style="color:var(--voice-color)">${fmtNum(voiceSent)}</td></tr>
            <tr><td class="metric-name">Failed</td><td class="yesterday">${fmtNum(yesterdayFailed)}</td><td>${fmtNum(failedToday)}</td></tr>
        `;

        // ── Section 6: Aggregate Breakdown ──
        buildAggregates(queuedItems, sentTodayItems);

        // ── Update timestamp ──
        document.getElementById('lastUpdated').textContent = `Updated ${fmtTime(new Date())} (${Math.round(performance.now() - t0)}ms)`;
    } catch (err) {
        console.error('Load error:', err);
        document.getElementById('lastUpdated').textContent = `Error: ${err.message}`;
    }
}

// ============================================================
//  HOURLY CHART
// ============================================================
function updateHourlyChart(sentItems) {
    const hours = Array.from({ length: 12 }, (_, i) => i + 8);
    const smsByHour = new Array(12).fill(0);
    const voiceByHour = new Array(12).fill(0);

    for (const item of sentItems) {
        const d = new Date(item.updated_at);
        const estHour = parseInt(d.toLocaleString('en-US', { hour: 'numeric', hour12: false, timeZone: 'America/New_York' }));
        const idx = estHour - 8;
        if (idx >= 0 && idx < 12) {
            if (item.channel === 'sms') smsByHour[idx]++;
            else voiceByHour[idx]++;
        }
    }

    const labels = hours.map(h => {
        const ampm = h >= 12 ? 'pm' : 'am';
        const h12 = h > 12 ? h - 12 : h;
        return `${h12}${ampm}`;
    });

    const currentHourEST = nowEST().getHours();
    const barColors = hours.map(h => h === currentHourEST ? 'rgba(0,188,212,0.3)' : 'transparent');

    const ctx = document.getElementById('hourlyChart').getContext('2d');
    if (hourlyChart) hourlyChart.destroy();

    hourlyChart = new Chart(ctx, {
        type: 'bar',
        data: {
            labels,
            datasets: [
                {
                    label: 'SMS',
                    data: smsByHour,
                    backgroundColor: 'rgba(0,200,83,0.8)',
                    borderRadius: 3,
                },
                {
                    label: 'Voice',
                    data: voiceByHour,
                    backgroundColor: 'rgba(171,71,188,0.8)',
                    borderRadius: 3,
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'top',
                    labels: { color: '#9e9e9e', font: { size: 11 }, boxWidth: 12, padding: 12 }
                },
                tooltip: {
                    callbacks: {
                        footer: items => `Total: ${items.reduce((s, i) => s + i.raw, 0)}`
                    }
                }
            },
            scales: {
                x: {
                    stacked: true,
                    ticks: { color: '#666', font: { size: 11 } },
                    grid: { display: false }
                },
                y: {
                    stacked: true,
                    beginAtZero: true,
                    ticks: { color: '#666', font: { size: 11 } },
                    grid: { color: 'rgba(255,255,255,0.05)' }
                }
            }
        }
    });
}

// ============================================================
//  AGGREGATES (Section 6)
// ============================================================
function buildAggregates(queuedItems, sentTodayItems) {
    // Parse queue items for aggregation
    const queued = queuedItems.filter(r => r.status === 'queued');
    const sent = sentTodayItems;

    // Helper to parse template_key
    function parseStep(tk) {
        const m = (tk || '').match(/\.s(\d+)/);
        return m ? parseInt(m[1]) : 0;
    }
    function parseTier(tk, meta) {
        if (meta && typeof meta === 'object' && meta.urgency_tier) return meta.urgency_tier;
        const m = (tk || '').match(/\.v(\d+)\./);
        return m ? 'V' + m[1] : 'V?';
    }
    function parseSegment(tk, meta) {
        if (meta && typeof meta === 'object' && meta.audience_type) return meta.audience_type;
        const parts = (tk || '').replace(/^(sms|voice)\./, '').split('.');
        return parts[0] || 'unknown';
    }
    function parseCounty(meta) {
        if (meta && typeof meta === 'object') return meta.county || 'Unknown';
        return 'Unknown';
    }
    function safeMeta(m) {
        if (!m) return {};
        if (typeof m === 'string') { try { return JSON.parse(m); } catch { return {}; } }
        return m;
    }

    const tabs = [
        { id: 'channel', label: 'Channel' },
        { id: 'tier', label: 'Tier' },
        { id: 'segment', label: 'Segment' },
        { id: 'step', label: 'Step' },
        { id: 'county', label: 'County' },
    ];

    // Build tab buttons
    document.getElementById('aggTabs').innerHTML = tabs.map((t, i) =>
        `<button class="tab-btn ${i === 0 ? 'active' : ''}" onclick="switchTab('${t.id}')">${t.label}</button>`
    ).join('');

    // Aggregate data
    const agg = {};

    // Channel
    agg.channel = {};
    for (const item of queued) {
        const k = item.channel || 'unknown';
        agg.channel[k] = agg.channel[k] || { queued: 0, sent: 0 };
        agg.channel[k].queued++;
    }
    for (const item of sent) {
        const k = item.channel || 'unknown';
        agg.channel[k] = agg.channel[k] || { queued: 0, sent: 0 };
        agg.channel[k].sent++;
    }

    // Tier
    agg.tier = {};
    for (const item of queued) {
        const m = safeMeta(item.meta);
        const k = parseTier(item.template_key, m);
        agg.tier[k] = agg.tier[k] || { queued: 0, sent: 0 };
        agg.tier[k].queued++;
    }
    for (const item of sent) {
        const m = safeMeta(item.meta);
        const k = parseTier(item.template_key, m);
        agg.tier[k] = agg.tier[k] || { queued: 0, sent: 0 };
        agg.tier[k].sent++;
    }

    // Segment
    agg.segment = {};
    for (const item of queued) {
        const m = safeMeta(item.meta);
        const k = parseSegment(item.template_key, m);
        agg.segment[k] = agg.segment[k] || { queued: 0, sent: 0 };
        agg.segment[k].queued++;
    }
    for (const item of sent) {
        const m = safeMeta(item.meta);
        const k = parseSegment(item.template_key, m);
        agg.segment[k] = agg.segment[k] || { queued: 0, sent: 0 };
        agg.segment[k].sent++;
    }

    // Step
    agg.step = {};
    const stepLabels = { 1: 'Step 1 (First touch)', 2: 'Step 2', 3: 'Step 3', 4: 'Step 4' };
    for (const item of queued) {
        const s = parseStep(item.template_key);
        const k = stepLabels[s] || `Step ${s}`;
        agg.step[k] = agg.step[k] || { queued: 0, sent: 0 };
        agg.step[k].queued++;
    }
    for (const item of sent) {
        const s = parseStep(item.template_key);
        const k = stepLabels[s] || `Step ${s}`;
        agg.step[k] = agg.step[k] || { queued: 0, sent: 0 };
        agg.step[k].sent++;
    }

    // County (from meta)
    agg.county = {};
    for (const item of queued) {
        const m = safeMeta(item.meta);
        const k = parseCounty(m);
        agg.county[k] = agg.county[k] || { queued: 0, sent: 0 };
        agg.county[k].queued++;
    }
    for (const item of sent) {
        const m = safeMeta(item.meta);
        const k = parseCounty(m);
        agg.county[k] = agg.county[k] || { queued: 0, sent: 0 };
        agg.county[k].sent++;
    }

    // Store for tab switching
    window._aggData = agg;
    switchTab('channel');
}

function switchTab(tabId) {
    document.querySelectorAll('.tab-btn').forEach(b => b.classList.toggle('active', b.textContent.toLowerCase() === tabId));
    const data = window._aggData[tabId] || {};
    const entries = Object.entries(data).sort((a, b) => (b[1].queued + b[1].sent) - (a[1].queued + a[1].sent));
    const maxTotal = Math.max(...entries.map(([, v]) => v.queued + v.sent), 1);

    // Show top 15 for county, all for others
    const display = tabId === 'county' ? entries.slice(0, 15) : entries;
    const grandQueued = display.reduce((s, [, v]) => s + v.queued, 0);

    let html = `<table class="agg-table">
        <tr><th>${tabId.charAt(0).toUpperCase() + tabId.slice(1)}</th><th>Queued</th><th>Sent Today</th><th>% of Queue</th><th></th></tr>`;

    for (const [key, val] of display) {
        const pct = grandQueued > 0 ? (val.queued / grandQueued * 100).toFixed(1) : '0.0';
        const barW = (val.queued + val.sent) / maxTotal * 100;
        html += `<tr>
            <td>${formatSegmentName(key)}</td>
            <td>${fmtNum(val.queued)}</td>
            <td>${fmtNum(val.sent)}</td>
            <td>${pct}%</td>
            <td><div class="bar-cell"><div class="mini-bar" style="width:${barW}%;background:var(--accent-cyan)"></div></div></td>
        </tr>`;
    }
    html += '</table>';
    document.getElementById('aggContent').innerHTML = html;
}

function formatSegmentName(s) {
    return s.replace(/_/g, ' ').replace(/\b\w/g, c => c.toUpperCase());
}

// ============================================================
//  AUTO-REFRESH
// ============================================================
function startCountdown() {
    if (countdownTimer) clearInterval(countdownTimer);
    secondsLeft = REFRESH_INTERVAL;
    countdownTimer = setInterval(() => {
        secondsLeft--;
        document.getElementById('countdown').textContent = `${secondsLeft}s`;
        if (secondsLeft <= 0) {
            loadAll();
        }
    }, 1000);
}

// ============================================================
//  INIT
// ============================================================
document.addEventListener('DOMContentLoaded', () => {
    loadAll();
    startCountdown();
});
</script>
</body>
</html>
