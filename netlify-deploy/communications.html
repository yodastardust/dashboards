<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lead Communications Dashboard - Stop My Auction Now</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            min-height: 100vh;
            color: #e4e4e4;
        }
        .header {
            background: rgba(255,255,255,0.05);
            padding: 20px 40px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }
        .nav-links {
            display: flex;
            gap: 10px;
            margin-left: 20px;
        }
        .nav-link {
            padding: 8px 15px;
            border: 1px solid rgba(255,255,255,0.2);
            border-radius: 6px;
            background: rgba(255,255,255,0.05);
            color: #aaa;
            text-decoration: none;
            font-size: 0.85rem;
            transition: all 0.2s;
        }
        .nav-link:hover, .nav-link.active {
            background: linear-gradient(90deg, #00d4ff, #7b2cbf);
            color: #fff;
            border-color: transparent;
        }
        .header-left {
            display: flex;
            align-items: center;
        }
        .header h1 {
            font-size: 1.5rem;
            background: linear-gradient(90deg, #00d4ff, #7b2cbf);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        .header-stats { display: flex; gap: 30px; }
        .header-stat { text-align: center; }
        .header-stat-value { font-size: 1.5rem; font-weight: bold; color: #00d4ff; }
        .header-stat-label { font-size: 0.75rem; color: #888; text-transform: uppercase; }
        .container { display: flex; height: calc(100vh - 80px); }
        .sidebar {
            width: 350px;
            background: rgba(255,255,255,0.03);
            border-right: 1px solid rgba(255,255,255,0.1);
            display: flex;
            flex-direction: column;
        }
        .search-box { padding: 15px; border-bottom: 1px solid rgba(255,255,255,0.1); }
        .search-box input {
            width: 100%;
            padding: 12px 15px;
            border: 1px solid rgba(255,255,255,0.2);
            border-radius: 8px;
            background: rgba(255,255,255,0.05);
            color: #fff;
            font-size: 0.9rem;
        }
        .filters {
            padding: 10px 15px;
            display: flex;
            gap: 10px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }
        .filter-btn {
            padding: 6px 12px;
            border: 1px solid rgba(255,255,255,0.2);
            border-radius: 20px;
            background: transparent;
            color: #888;
            cursor: pointer;
            font-size: 0.8rem;
        }
        .filter-btn.active { background: #00d4ff; color: #000; border-color: #00d4ff; }
        .contact-list { flex: 1; overflow-y: auto; }
        .contact-item {
            padding: 15px;
            border-bottom: 1px solid rgba(255,255,255,0.05);
            cursor: pointer;
        }
        .contact-item:hover { background: rgba(255,255,255,0.05); }
        .contact-item.active { background: rgba(0,212,255,0.1); border-left: 3px solid #00d4ff; }
        .contact-name { font-weight: 600; margin-bottom: 4px; }
        .contact-phone { font-size: 0.85rem; color: #888; }
        .contact-meta { display: flex; gap: 15px; margin-top: 8px; font-size: 0.75rem; }
        .main-content { flex: 1; display: flex; flex-direction: column; overflow: hidden; }
        .contact-header {
            padding: 20px 30px;
            background: rgba(255,255,255,0.03);
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }
        .contact-header h2 { font-size: 1.3rem; margin-bottom: 5px; }
        .contact-details { display: flex; gap: 30px; font-size: 0.85rem; color: #888; }
        .tabs {
            display: flex;
            padding: 0 30px;
            background: rgba(255,255,255,0.02);
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }
        .tab {
            padding: 15px 20px;
            cursor: pointer;
            border-bottom: 2px solid transparent;
            color: #888;
        }
        .tab.active { color: #00d4ff; border-bottom-color: #00d4ff; }
        .tab-content { flex: 1; overflow-y: auto; padding: 20px 30px; }
        .timeline { position: relative; padding-left: 30px; }
        .timeline::before {
            content: '';
            position: absolute;
            left: 10px;
            top: 0;
            bottom: 0;
            width: 2px;
            background: rgba(255,255,255,0.1);
        }
        .timeline-item {
            position: relative;
            margin-bottom: 20px;
            padding: 15px;
            background: rgba(255,255,255,0.03);
            border-radius: 10px;
            border: 1px solid rgba(255,255,255,0.1);
        }
        .timeline-item::before {
            content: '';
            position: absolute;
            left: -24px;
            top: 20px;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: #00d4ff;
        }
        .timeline-item.sms::before { background: #7b2cbf; }
        .timeline-item.retell::before { background: #00ff88; }
        .timeline-header { display: flex; justify-content: space-between; margin-bottom: 10px; }
        .badge { padding: 3px 8px; border-radius: 4px; font-size: 0.7rem; text-transform: uppercase; }
        .badge-call { background: rgba(0,212,255,0.2); color: #00d4ff; }
        .badge-sms { background: rgba(123,44,191,0.2); color: #7b2cbf; }
        .badge-retell { background: rgba(0,255,136,0.2); color: #00ff88; }
        .badge-inbound { background: rgba(0,255,136,0.2); color: #00ff88; }
        .badge-outbound { background: rgba(255,165,0,0.2); color: #ffa500; }
        .timeline-date { font-size: 0.8rem; color: #666; }
        .timeline-content {
            background: rgba(0,0,0,0.2);
            padding: 15px;
            border-radius: 8px;
            font-size: 0.9rem;
            line-height: 1.6;
            max-height: 300px;
            overflow-y: auto;
        }
        .transcript-line { margin-bottom: 10px; }
        .transcript-line.agent { color: #00d4ff; }
        .transcript-line.user { color: #00ff88; }
        .sms-bubble { max-width: 80%; padding: 10px 15px; border-radius: 15px; margin-bottom: 10px; }
        .sms-bubble.outbound { background: #00d4ff; color: #000; margin-left: auto; }
        .sms-bubble.inbound { background: rgba(255,255,255,0.1); }
        .call-summary {
            background: rgba(0,212,255,0.1);
            padding: 12px;
            border-radius: 8px;
            margin-top: 10px;
            border-left: 3px solid #00d4ff;
        }
        .no-selection {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            color: #666;
        }
        .loading { display: flex; align-items: center; justify-content: center; padding: 40px; }
        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 3px solid rgba(255,255,255,0.1);
            border-top-color: #00d4ff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { to { transform: rotate(360deg); } }
        .status-dot { width: 8px; height: 8px; border-radius: 50%; background: #00ff88; display: inline-block; margin-right: 5px; }
        .status-dot.offline { background: #ff6464; }
    </style>
</head>
<body>
    <div class="header">
        <div class="header-left">
            <h1>Lead Communications Dashboard</h1>
            <div class="nav-links">
                <a href="index.html" class="nav-link">KPI Dashboard</a>
                <a href="communications.html" class="nav-link active">Communications</a>
                <a href="todays_queue.html" class="nav-link">Outreach Schedule</a>
            </div>
        </div>
        <div class="header-stats">
            <div class="header-stat">
                <div class="header-stat-value" id="total-contacts">-</div>
                <div class="header-stat-label">Total Leads</div>
            </div>
            <div class="header-stat">
                <div class="header-stat-value" id="total-calls">-</div>
                <div class="header-stat-label">Total Calls</div>
            </div>
            <div class="header-stat">
                <div class="header-stat-value" id="total-sms">-</div>
                <div class="header-stat-label">Total SMS</div>
            </div>
            <div class="header-stat">
                <div class="header-stat-value" id="total-transcripts">-</div>
                <div class="header-stat-label">Transcripts</div>
            </div>
            <div style="display: flex; align-items: center; font-size: 0.8rem;">
                <div class="status-dot" id="status-dot"></div>
                <span id="connection-text">Loading...</span>
            </div>
        </div>
    </div>

    <div class="container">
        <div class="sidebar">
            <div class="search-box">
                <input type="text" id="search-input" placeholder="Search by name, phone, or address...">
            </div>
            <div class="filters">
                <button class="filter-btn active" data-filter="all">All</button>
                <button class="filter-btn" data-filter="with-transcripts">With Transcripts</button>
                <button class="filter-btn" data-filter="with-sms">With SMS</button>
                <button class="filter-btn" data-filter="high-touch">10+ Touches</button>
            </div>
            <div class="contact-list" id="contact-list">
                <div class="loading"><div class="loading-spinner"></div></div>
            </div>
        </div>

        <div class="main-content">
            <div id="no-selection" class="no-selection">
                <svg xmlns="http://www.w3.org/2000/svg" width="80" height="80" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
                </svg>
                <p>Select a contact to view communications</p>
            </div>
            <div id="contact-view" style="display: none; flex-direction: column; height: 100%;">
                <div class="contact-header">
                    <h2 id="selected-name"></h2>
                    <div class="contact-details">
                        <span id="selected-phone"></span>
                        <span id="selected-address"></span>
                        <span id="selected-auction"></span>
                        <span id="selected-added"></span>
                    </div>
                </div>
                <div class="tabs">
                    <div class="tab active" data-tab="timeline">Timeline</div>
                    <div class="tab" data-tab="transcripts">Transcripts</div>
                    <div class="tab" data-tab="sms">SMS</div>
                    <div class="tab" data-tab="calls">Calls</div>
                </div>
                <div class="tab-content" id="tab-content"></div>
            </div>
        </div>
    </div>

    <script>
        // Global state
        let contactsData = [];
        let selectedContact = null;
        let currentFilter = 'all';
        let currentTab = 'timeline';

        // Load data from external JSON file
        async function loadData() {
            try {
                const response = await fetch('full_analysis_with_transcripts.json');
                if (!response.ok) throw new Error('Failed to load JSON');
                contactsData = await response.json();
                document.getElementById('status-dot').classList.remove('offline');
                document.getElementById('connection-text').textContent = 'Loaded ' + contactsData.length + ' contacts';
                return true;
            } catch (error) {
                console.error('Error loading data:', error);
                document.getElementById('status-dot').classList.add('offline');
                document.getElementById('connection-text').textContent = 'Error loading data';
                return false;
            }
        }

        // Initialize
        async function init() {
            const loaded = await loadData();
            if (loaded) {
                setupEventListeners();
                renderContactList();
                updateHeaderStats();
            } else {
                document.getElementById('contact-list').innerHTML = '<div style="padding: 20px; text-align: center; color: #888;">Failed to load data. Please check that full_analysis_with_transcripts.json exists.</div>';
            }
        }

        function updateHeaderStats() {
            document.getElementById('total-contacts').textContent = contactsData.length;
            let totalCalls = 0, totalSms = 0, totalTranscripts = 0;
            contactsData.forEach(c => {
                totalCalls += (c.call_details || []).length;
                totalSms += (c.sms_conversation || []).length;
                totalTranscripts += (c.retell_transcriptions || []).length;
            });
            document.getElementById('total-calls').textContent = totalCalls;
            document.getElementById('total-sms').textContent = totalSms;
            document.getElementById('total-transcripts').textContent = totalTranscripts;
        }

        function setupEventListeners() {
            document.getElementById('search-input').addEventListener('input', e => renderContactList(e.target.value));
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    currentFilter = btn.dataset.filter;
                    renderContactList();
                });
            });
            document.querySelectorAll('.tab').forEach(tab => {
                tab.addEventListener('click', () => {
                    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                    tab.classList.add('active');
                    currentTab = tab.dataset.tab;
                    renderTabContent();
                });
            });
        }

        function filterContacts(contacts, searchTerm = '') {
            let filtered = contacts;
            if (currentFilter === 'with-transcripts') filtered = filtered.filter(c => c.retell_transcriptions && c.retell_transcriptions.length > 0);
            else if (currentFilter === 'with-sms') filtered = filtered.filter(c => c.sms_conversation && c.sms_conversation.length > 0);
            else if (currentFilter === 'high-touch') filtered = filtered.filter(c => c.total_touches >= 10);
            if (searchTerm) {
                const term = searchTerm.toLowerCase();
                filtered = filtered.filter(c =>
                    (c.name && c.name.toLowerCase().includes(term)) ||
                    (c.phone && c.phone.includes(term)) ||
                    (c.property_address && c.property_address.toLowerCase().includes(term))
                );
            }
            return filtered;
        }

        function renderContactList(searchTerm = '') {
            const list = document.getElementById('contact-list');
            const filtered = filterContacts(contactsData, searchTerm);
            if (filtered.length === 0) {
                list.innerHTML = '<div style="padding: 20px; text-align: center; color: #888;">No contacts found</div>';
                return;
            }
            list.innerHTML = filtered.map(contact => `
                <div class="contact-item ${selectedContact && selectedContact.contact_id === contact.contact_id ? 'active' : ''}" data-id="${contact.contact_id}">
                    <div class="contact-name">${contact.name || 'Unknown'}</div>
                    <div class="contact-phone">${contact.phone || '-'}</div>
                    <div class="contact-meta">
                        <span style="color: #00d4ff;">Calls: ${(contact.call_details || []).length}</span>
                        <span style="color: #7b2cbf;">SMS: ${(contact.sms_conversation || []).length}</span>
                        <span style="color: #00ff88;">Transcripts: ${(contact.retell_transcriptions || []).length}</span>
                    </div>
                </div>
            `).join('');
            list.querySelectorAll('.contact-item').forEach(item => {
                item.addEventListener('click', () => {
                    const contact = contactsData.find(c => c.contact_id === item.dataset.id);
                    selectContact(contact);
                });
            });
        }

        function selectContact(contact) {
            selectedContact = contact;
            document.getElementById('no-selection').style.display = 'none';
            document.getElementById('contact-view').style.display = 'flex';
            document.getElementById('selected-name').textContent = contact.name || 'Unknown';
            document.getElementById('selected-phone').textContent = contact.phone || '-';
            document.getElementById('selected-address').textContent = contact.property_address || '';
            document.getElementById('selected-auction').textContent = contact.auction_date ? 'Auction: ' + contact.auction_date : '';
            document.getElementById('selected-added').textContent = contact.date_added ? 'Added: ' + formatDate(contact.date_added) : '';
            document.querySelectorAll('.contact-item').forEach(item => {
                item.classList.toggle('active', item.dataset.id === contact.contact_id);
            });
            renderTabContent();
        }

        function formatDate(dateStr) {
            try { return new Date(dateStr).toLocaleDateString(); } catch { return dateStr; }
        }

        function renderTabContent() {
            if (!selectedContact) return;
            const content = document.getElementById('tab-content');
            if (currentTab === 'timeline') renderTimeline(content);
            else if (currentTab === 'transcripts') renderTranscripts(content);
            else if (currentTab === 'sms') renderSMS(content);
            else if (currentTab === 'calls') renderCalls(content);
        }

        function renderTimeline(container) {
            const events = [];
            (selectedContact.call_details || []).forEach(call => events.push({ type: 'call', date: new Date(call.date), data: call }));
            (selectedContact.sms_conversation || []).forEach(sms => events.push({ type: 'sms', date: new Date(sms.date), data: sms }));
            (selectedContact.retell_transcriptions || []).forEach(t => events.push({ type: 'retell', date: new Date(t.start_timestamp), data: t }));
            events.sort((a, b) => b.date - a.date);
            if (events.length === 0) {
                container.innerHTML = '<div style="text-align: center; color: #888; padding: 40px;">No communications found</div>';
                return;
            }
            container.innerHTML = '<div class="timeline">' + events.map(event => {
                if (event.type === 'call') return renderCallItem(event);
                if (event.type === 'sms') return renderSmsItem(event);
                if (event.type === 'retell') return renderRetellItem(event);
            }).join('') + '</div>';
        }

        function renderCallItem(event) {
            const call = event.data;
            const direction = call.direction?.includes('inbound') ? 'Inbound' : 'Outbound';
            return `<div class="timeline-item call">
                <div class="timeline-header">
                    <span><span class="badge badge-call">Call</span> <span class="badge ${direction === 'Inbound' ? 'badge-inbound' : 'badge-outbound'}">${direction}</span></span>
                    <span class="timeline-date">${formatDate(call.date)}</span>
                </div>
                <div style="font-size: 0.85rem; color: #888;">Duration: ${call.duration || 0}s | Status: ${call.status || 'unknown'}</div>
            </div>`;
        }

        function renderSmsItem(event) {
            const sms = event.data;
            const direction = sms.direction === 'inbound' ? 'Inbound' : 'Outbound';
            return `<div class="timeline-item sms">
                <div class="timeline-header">
                    <span><span class="badge badge-sms">SMS</span> <span class="badge ${direction === 'Inbound' ? 'badge-inbound' : 'badge-outbound'}">${direction}</span></span>
                    <span class="timeline-date">${formatDate(sms.date)}</span>
                </div>
                <div class="timeline-content">${sms.body || ''}</div>
            </div>`;
        }

        function renderRetellItem(event) {
            const t = event.data;
            return `<div class="timeline-item retell">
                <div class="timeline-header">
                    <span><span class="badge badge-retell">Retell AI</span></span>
                    <span class="timeline-date">${formatDate(t.start_timestamp)}</span>
                </div>
                <div style="font-size: 0.85rem; color: #888; margin-bottom: 10px;">Duration: ${Math.round((t.end_timestamp - t.start_timestamp) / 1000)}s</div>
                ${t.call_summary ? `<div class="call-summary"><strong>Summary:</strong> ${t.call_summary}</div>` : ''}
                <div class="timeline-content" style="margin-top: 10px;">
                    ${(t.transcript_object || []).map(line => `<div class="transcript-line ${line.role}">${line.role === 'agent' ? 'Agent' : 'User'}: ${line.content}</div>`).join('')}
                </div>
            </div>`;
        }

        function renderTranscripts(container) {
            const transcripts = selectedContact.retell_transcriptions || [];
            if (transcripts.length === 0) {
                container.innerHTML = '<div style="text-align: center; color: #888; padding: 40px;">No transcripts available</div>';
                return;
            }
            container.innerHTML = transcripts.map(t => `
                <div style="background: rgba(255,255,255,0.03); border-radius: 10px; padding: 20px; margin-bottom: 20px; border: 1px solid rgba(255,255,255,0.1);">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 15px;">
                        <span style="color: #00ff88; font-weight: bold;">Retell AI Call</span>
                        <span style="color: #666; font-size: 0.85rem;">${formatDate(t.start_timestamp)}</span>
                    </div>
                    ${t.call_summary ? `<div class="call-summary" style="margin-bottom: 15px;"><strong>Summary:</strong> ${t.call_summary}</div>` : ''}
                    <div class="timeline-content">
                        ${(t.transcript_object || []).map(line => `<div class="transcript-line ${line.role}"><strong>${line.role === 'agent' ? 'Agent' : 'User'}:</strong> ${line.content}</div>`).join('')}
                    </div>
                </div>
            `).join('');
        }

        function renderSMS(container) {
            const sms = selectedContact.sms_conversation || [];
            if (sms.length === 0) {
                container.innerHTML = '<div style="text-align: center; color: #888; padding: 40px;">No SMS messages</div>';
                return;
            }
            container.innerHTML = '<div style="display: flex; flex-direction: column; gap: 10px;">' +
                sms.map(msg => `<div class="sms-bubble ${msg.direction}">${msg.body || ''}<div style="font-size: 0.7rem; opacity: 0.7; margin-top: 5px;">${formatDate(msg.date)}</div></div>`).join('') +
            '</div>';
        }

        function renderCalls(container) {
            const calls = selectedContact.call_details || [];
            if (calls.length === 0) {
                container.innerHTML = '<div style="text-align: center; color: #888; padding: 40px;">No calls recorded</div>';
                return;
            }
            container.innerHTML = `<table style="width: 100%; border-collapse: collapse;">
                <thead><tr style="border-bottom: 1px solid rgba(255,255,255,0.1);">
                    <th style="padding: 10px; text-align: left; color: #888;">Date</th>
                    <th style="padding: 10px; text-align: left; color: #888;">Direction</th>
                    <th style="padding: 10px; text-align: left; color: #888;">Duration</th>
                    <th style="padding: 10px; text-align: left; color: #888;">Status</th>
                </tr></thead>
                <tbody>${calls.map(call => `<tr style="border-bottom: 1px solid rgba(255,255,255,0.05);">
                    <td style="padding: 10px;">${formatDate(call.date)}</td>
                    <td style="padding: 10px;"><span class="badge ${call.direction?.includes('inbound') ? 'badge-inbound' : 'badge-outbound'}">${call.direction?.includes('inbound') ? 'Inbound' : 'Outbound'}</span></td>
                    <td style="padding: 10px;">${call.duration || 0}s</td>
                    <td style="padding: 10px;">${call.status || 'unknown'}</td>
                </tr>`).join('')}</tbody>
            </table>`;
        }

        // Start the app
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
