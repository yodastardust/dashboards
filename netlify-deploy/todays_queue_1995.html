<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <title>*** TODAY'S OUTREACH SCHEDULE *** Welcome to My Homepage!</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body {
            font-family: 'Times New Roman', Times, serif;
            background-color: #c0c0c0;
            background-image: url('data:image/gif;base64,R0lGODlhCgAKAIAAAP///8zMzCH5BAAAAAAALAAAAAAKAAoAAAIRhI+py+0Po5y02ouz3rz7rxUAOw==');
            color: #000080;
            margin: 0;
            padding: 10px;
        }

        .page-container {
            max-width: 800px;
            margin: 0 auto;
            background: #ffffff;
            border: 3px outset #dfdfdf;
            padding: 0;
        }

        .header-banner {
            background: linear-gradient(to right, #000080, #0000ff, #000080);
            padding: 15px;
            text-align: center;
            border-bottom: 3px groove #808080;
        }

        .header-banner h1 {
            color: #ffff00;
            font-size: 28px;
            font-family: 'Comic Sans MS', 'Arial Black', sans-serif;
            text-shadow: 2px 2px #000000;
            margin: 0;
            animation: blink 1s step-end infinite;
        }

        @keyframes blink {
            50% { opacity: 0.5; }
        }

        .marquee-bar {
            background: #000000;
            color: #00ff00;
            padding: 5px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            overflow: hidden;
        }

        .marquee-content {
            display: inline-block;
            animation: marquee 15s linear infinite;
            white-space: nowrap;
        }

        @keyframes marquee {
            0% { transform: translateX(100%); }
            100% { transform: translateX(-100%); }
        }

        .nav-table {
            width: 100%;
            background: #c0c0c0;
            border: 2px inset #808080;
        }

        .nav-table td {
            padding: 5px;
        }

        .nav-button {
            display: inline-block;
            padding: 5px 15px;
            background: #c0c0c0;
            border: 2px outset #ffffff;
            color: #000000;
            text-decoration: none;
            font-family: 'MS Sans Serif', Arial, sans-serif;
            font-size: 12px;
            cursor: pointer;
        }

        .nav-button:active, .nav-button.active {
            border: 2px inset #808080;
            background: #a0a0a0;
        }

        .nav-button:hover {
            background: #d0d0d0;
        }

        hr.fancy {
            height: 3px;
            border: none;
            background: linear-gradient(to right, #ff0000, #ffff00, #00ff00, #00ffff, #0000ff, #ff00ff, #ff0000);
        }

        .content-area {
            padding: 15px;
            background: #ffffff;
        }

        .welcome-box {
            background: #ffffcc;
            border: 2px dashed #ff0000;
            padding: 10px;
            margin-bottom: 15px;
            text-align: center;
        }

        .welcome-box img {
            vertical-align: middle;
        }

        .status-frame {
            border: 3px ridge #808080;
            background: #f0f0f0;
            padding: 10px;
            margin-bottom: 15px;
        }

        .status-frame .title {
            background: #000080;
            color: #ffffff;
            padding: 3px 8px;
            font-weight: bold;
            font-size: 12px;
            margin: -10px -10px 10px -10px;
        }

        .info-table {
            width: 100%;
            border-collapse: collapse;
            border: 2px inset #808080;
            background: #ffffff;
        }

        .info-table th {
            background: #000080;
            color: #ffffff;
            padding: 8px;
            border: 1px solid #000000;
            font-size: 12px;
        }

        .info-table td {
            padding: 6px 8px;
            border: 1px solid #808080;
            font-size: 12px;
        }

        .info-table tr:nth-child(even) {
            background: #e0e0e0;
        }

        .info-table tr:hover {
            background: #ffffcc;
        }

        .stats-table {
            width: 100%;
            border: 3px outset #c0c0c0;
            border-collapse: separate;
            border-spacing: 5px;
            background: #c0c0c0;
            margin-bottom: 15px;
        }

        .stats-table td {
            background: #ffffff;
            border: 2px inset #808080;
            padding: 10px;
            text-align: center;
            width: 20%;
        }

        .stat-label {
            font-size: 11px;
            color: #808080;
            text-transform: uppercase;
        }

        .stat-value {
            font-size: 24px;
            font-weight: bold;
            color: #ff0000;
            font-family: 'Arial Black', sans-serif;
        }

        .stat-value.sms { color: #008000; }
        .stat-value.voice { color: #800080; }
        .stat-value.pending { color: #ff8000; }
        .stat-value.sent { color: #0000ff; }

        .section-header {
            background: #808080;
            color: #ffffff;
            padding: 5px 10px;
            font-weight: bold;
            font-size: 14px;
            border: 2px outset #a0a0a0;
            margin-top: 15px;
        }

        .badge {
            display: inline-block;
            padding: 2px 8px;
            font-size: 10px;
            font-weight: bold;
            border: 1px solid #000000;
        }

        .badge.sms { background: #00ff00; color: #000000; }
        .badge.voice { background: #ff00ff; color: #ffffff; }
        .badge.v1 { background: #00ffff; color: #000000; }
        .badge.v2 { background: #ffff00; color: #000000; }
        .badge.v3 { background: #ffa500; color: #000000; }
        .badge.v4 { background: #ff0000; color: #ffffff; }
        .badge.queued { background: #ffff00; color: #000000; }
        .badge.sent { background: #00ff00; color: #000000; }

        .filter-buttons {
            margin: 10px 0;
            padding: 5px;
            background: #c0c0c0;
            border: 2px inset #808080;
        }

        .filter-btn {
            padding: 3px 10px;
            margin-right: 5px;
            background: #c0c0c0;
            border: 2px outset #ffffff;
            font-family: 'MS Sans Serif', Arial, sans-serif;
            font-size: 11px;
            cursor: pointer;
        }

        .filter-btn:active, .filter-btn.active {
            border: 2px inset #808080;
            background: #a0a0a0;
        }

        .construction-gif {
            text-align: center;
            padding: 10px;
            font-size: 12px;
            color: #ff0000;
        }

        .footer {
            background: #c0c0c0;
            border-top: 3px groove #808080;
            padding: 10px;
            text-align: center;
            font-size: 11px;
        }

        .footer img {
            vertical-align: middle;
        }

        .counter-box {
            display: inline-block;
            background: #000000;
            color: #00ff00;
            font-family: 'Courier New', monospace;
            padding: 3px 8px;
            border: 2px inset #808080;
            margin: 5px;
        }

        .chart-frame {
            border: 3px ridge #808080;
            background: #ffffff;
            padding: 10px;
            margin: 10px 0;
        }

        .chart-title {
            background: #000080;
            color: #ffff00;
            padding: 5px;
            font-weight: bold;
            font-size: 12px;
            text-align: center;
            margin: -10px -10px 10px -10px;
        }

        .chart-container {
            height: 200px;
        }

        .chart-container.wide {
            height: 150px;
        }

        .charts-row {
            display: flex;
            gap: 10px;
        }

        .charts-row .chart-frame {
            flex: 1;
        }

        .chart-frame.full-width {
            margin-top: 10px;
        }

        .summary-box {
            background: #ffffcc;
            border: 2px solid #808080;
            padding: 10px;
            margin-bottom: 15px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
        }

        .summary-box b { color: #0000ff; }
        .summary-box .pct { color: #ff0000; font-weight: bold; }

        .guestbook-link {
            color: #0000ff;
            text-decoration: underline;
        }

        .guestbook-link:visited {
            color: #800080;
        }

        .email-link {
            color: #ff0000;
        }

        .new-gif {
            color: #ff0000;
            font-weight: bold;
            font-size: 10px;
            animation: blink 0.5s step-end infinite;
        }

        .under-construction {
            text-align: center;
            padding: 5px;
            background: #ffff00;
            border: 2px dashed #ff0000;
            font-size: 12px;
            color: #ff0000;
            font-weight: bold;
        }

        .dispatch-box {
            background: #ccffcc;
            border: 3px double #008000;
            padding: 10px;
            margin-bottom: 15px;
        }

        .dispatch-box h3 {
            margin: 0 0 5px 0;
            color: #008000;
            font-size: 14px;
        }

        .dispatch-stats {
            display: flex;
            justify-content: space-around;
            margin-top: 10px;
        }

        .dispatch-stat {
            text-align: center;
        }

        .dispatch-stat-value {
            font-size: 20px;
            font-weight: bold;
            color: #008000;
        }

        .dispatch-stat-label {
            font-size: 10px;
            color: #666666;
        }

        .empty-state {
            text-align: center;
            padding: 30px;
            color: #808080;
            font-style: italic;
        }

        .tier-desc {
            color: #808080;
            font-size: 10px;
        }

        /* Responsive adjustments */
        @media (max-width: 800px) {
            .stats-table td { width: auto; }
            .charts-row { flex-direction: column; }
        }
    </style>
</head>
<body>
    <div class="page-container">
        <div class="header-banner">
            <h1>&#x2605; TODAY'S OUTREACH SCHEDULE &#x2605;</h1>
            <font size="2" color="#ffffff">~ Your #1 Source for SMS Queue Information! ~</font>
        </div>

        <div class="marquee-bar">
            <span class="marquee-content">
                *** WELCOME TO THE OUTREACH SCHEDULE PAGE! *** 3 MESSAGES PER MINUTE *** 8AM-8PM EASTERN *** COUNTY ROTATION ENABLED *** BEST VIEWED WITH NETSCAPE NAVIGATOR 3.0 ***
            </span>
        </div>

        <table class="nav-table">
            <tr>
                <td>
                    <a href="index.html" class="nav-button">&#x1F4CA; KPI Dashboard</a>
                    <a href="communications.html" class="nav-button">&#x1F4DE; Communications</a>
                    <a href="todays_queue_1995.html" class="nav-button active">&#x1F4CB; Outreach Schedule</a>
                    <span class="new-gif">&lt;NEW!&gt;</span>
                </td>
                <td align="right">
                    <button class="nav-button" onclick="loadAllData()">&#x1F504; REFRESH PAGE</button>
                </td>
            </tr>
        </table>

        <hr class="fancy">

        <div class="content-area">
            <div class="welcome-box">
                &#x1F3D7; <b>Welcome to my Outreach Schedule Page!</b> &#x1F3D7;<br>
                <font size="2">You are visitor number: </font>
                <span class="counter-box" id="visitorCount">001337</span>
            </div>

            <div class="status-frame">
                <div class="title">&#x1F4E1; STATUS</div>
                <div id="statusBanner">
                    <font color="#ff8000">&#x23F3; Loading queue data... Please wait...</font>
                </div>
            </div>

            <div class="dispatch-box">
                <h3>&#x1F4E4; SMS DISPATCHER STATUS: <font color="#00ff00">ACTIVE</font></h3>
                <p><font size="2">Sending 3 messages per minute | Operating hours: 8:00 AM - 8:00 PM Eastern</font></p>
                <div class="dispatch-stats">
                    <div class="dispatch-stat">
                        <div class="dispatch-stat-value" id="estCompletionTime">--:--</div>
                        <div class="dispatch-stat-label">Est. Completion</div>
                    </div>
                    <div class="dispatch-stat">
                        <div class="dispatch-stat-value" id="messagesPerHour">180</div>
                        <div class="dispatch-stat-label">Msgs/Hour</div>
                    </div>
                </div>
            </div>

            <div class="summary-box">
                <b>*** QUEUE SUMMARY (<span id="summaryTotal">--</span> contacts) ***</b><br>
                &#x2022; Audience: <span id="audienceDistribution">Loading...</span><br>
                &#x2022; Urgency: <span id="tierDistribution">Loading...</span><br>
                &#x2022; Counties: <span id="countyDistribution">Loading...</span>
            </div>

            <div class="section-header">&#x1F4CA; QUEUE STATISTICS</div>

            <table class="stats-table">
                <tr>
                    <td>
                        <div class="stat-label">Total Queued</div>
                        <div class="stat-value" id="totalQueued">--</div>
                    </td>
                    <td>
                        <div class="stat-label">SMS</div>
                        <div class="stat-value sms" id="smsCount">--</div>
                    </td>
                    <td>
                        <div class="stat-label">Voice</div>
                        <div class="stat-value voice" id="voiceCount">--</div>
                    </td>
                    <td>
                        <div class="stat-label">Pending</div>
                        <div class="stat-value pending" id="pendingCount">--</div>
                    </td>
                    <td>
                        <div class="stat-label">Sent Today</div>
                        <div class="stat-value sent" id="sentCount">--</div>
                    </td>
                </tr>
            </table>

            <div class="section-header">&#x1F4C8; CHARTS &amp; GRAPHS</div>

            <div class="charts-row">
                <div class="chart-frame">
                    <div class="chart-title">&#x25CF; URGENCY TIER DISTRIBUTION</div>
                    <div class="chart-container">
                        <canvas id="tierChart"></canvas>
                    </div>
                </div>
                <div class="chart-frame">
                    <div class="chart-title">&#x25CF; AUDIENCE TYPE</div>
                    <div class="chart-container">
                        <canvas id="audienceChart"></canvas>
                    </div>
                </div>
            </div>
            <div class="chart-frame full-width">
                <div class="chart-title">&#x25CF; HOURLY SCHEDULE</div>
                <div class="chart-container wide">
                    <canvas id="hourlyChart"></canvas>
                </div>
            </div>

            <div class="section-header">&#x1F4CB; MESSAGE QUEUE - SEND ORDER</div>

            <div class="under-construction">
                &#x26A0; ROTATION: 10 per county &rarr; next county &rarr; cycle back (prevents carrier flagging) &#x26A0;
            </div>

            <div class="filter-buttons">
                <b>Filter by:</b>
                <button class="filter-btn active" data-filter="all">All</button>
                <button class="filter-btn" data-filter="sms">SMS Only</button>
                <button class="filter-btn" data-filter="voice">Voice Only</button>
                <button class="filter-btn" data-filter="queued">Pending</button>
                <button class="filter-btn" data-filter="sent">Sent</button>
            </div>

            <table class="info-table">
                <thead>
                    <tr>
                        <th>Order #</th>
                        <th>Est. Send Time</th>
                        <th>Channel</th>
                        <th>Tier</th>
                        <th>County</th>
                        <th>Audience</th>
                        <th>Status</th>
                        <th>Count</th>
                    </tr>
                </thead>
                <tbody id="queueTableBody">
                    <tr>
                        <td colspan="8" class="empty-state">
                            &#x23F3; Loading queue data... Please wait...
                        </td>
                    </tr>
                </tbody>
            </table>

            <hr class="fancy">

            <div class="construction-gif">
                &#x1F6A7; This page is always under construction! &#x1F6A7;<br>
                <font size="2">Check back often for updates!</font>
            </div>
        </div>

        <div class="footer">
            <p>
                &#x1F4E7; <a href="mailto:webmaster@example.com" class="email-link">Email the Webmaster</a> |
                &#x1F4DD; <a href="#" class="guestbook-link">Sign my Guestbook!</a> |
                &#x1F517; <a href="#" class="guestbook-link">Link to me!</a>
            </p>
            <p>
                <img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" width="88" height="31" alt="Best viewed with Netscape">
                <span style="background:#000080;color:#ffffff;padding:2px 5px;font-size:10px;border:1px solid #ffffff;">Best viewed with Netscape Navigator 3.0</span>
                <span style="background:#ff0000;color:#ffffff;padding:2px 5px;font-size:10px;border:1px solid #ffffff;">800x600 resolution</span>
            </p>
            <p><font size="1" color="#808080">Copyright &copy; 1995-2026. All rights reserved. Last updated: <span id="lastUpdated">--</span></font></p>
            <p><font size="1"><blink>&#x2605;</blink> Thanks for visiting! <blink>&#x2605;</blink></font></p>
        </div>
    </div>

    <script>
        const SUPABASE_URL = 'https://saksbjogtkagedmlsrsv.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNha3Niam9ndGthZ2VkbWxzcnN2Iiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTc2OTI1NTEwMywiZXhwIjoyMDg0NjE1MTAzfQ.X7fHo2v_7HZBYZzggydteFbMh_y_pgQN78yynby5sI4';
        const MESSAGES_PER_MINUTE = 3;
        const START_HOUR = 8;
        const END_HOUR = 20;

        let tierChart, audienceChart, hourlyChart;
        let allQueueData = [];
        let rawQueueItems = [];

        document.addEventListener('DOMContentLoaded', () => {
            loadAllData();
            setupFilterButtons();
            // Fun visitor counter
            document.getElementById('visitorCount').textContent = String(Math.floor(Math.random() * 9000) + 1000).padStart(6, '0');
        });

        function setupFilterButtons() {
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    filterTable(btn.dataset.filter);
                });
            });
        }

        async function loadAllData() {
            updateStatus('loading', '<font color="#ff8000">&#x23F3; Loading queue data... Please wait...</font>');
            try {
                await loadTodaysQueue();
                await loadHourlyData();
                const now = new Date();
                document.getElementById('lastUpdated').textContent = now.toLocaleString();
                updateStatus('success', '<font color="#008000">&#x2714; Data loaded successfully!</font> Last update: ' + now.toLocaleTimeString());
            } catch (error) {
                console.error('Error loading data:', error);
                updateStatus('error', '<font color="#ff0000">&#x2716; ERROR: ' + error.message + '</font>');
            }
        }

        function updateStatus(type, message) {
            document.getElementById('statusBanner').innerHTML = message;
        }

        async function loadTodaysQueue() {
            const today = new Date().toISOString().split('T')[0];
            const url = `${SUPABASE_URL}/rest/v1/outreach_queue?next_action_at=gte.${today}&next_action_at=lt.${today}T23:59:59&select=queue_id,channel,status,next_action_at,meta,raw_row_id&order=next_action_at.asc`;

            const response = await fetch(url, {
                method: 'GET',
                headers: { 'apikey': SUPABASE_ANON_KEY, 'Authorization': `Bearer ${SUPABASE_ANON_KEY}`, 'Content-Type': 'application/json' }
            });

            if (!response.ok) throw new Error(`Failed to fetch queue: ${response.status}`);

            const rawData = await response.json();
            const rawRowIds = [...new Set(rawData.map(r => r.raw_row_id).filter(Boolean))];
            let propertyMap = {};

            if (rawRowIds.length > 0) {
                for (let i = 0; i < rawRowIds.length; i += 100) {
                    const batch = rawRowIds.slice(i, i + 100);
                    const propUrl = `${SUPABASE_URL}/rest/v1/marketing_ready_rows?raw_row_id=in.(${batch.join(',')})&select=raw_row_id,county,property_address`;
                    const propResponse = await fetch(propUrl, {
                        headers: { 'apikey': SUPABASE_ANON_KEY, 'Authorization': `Bearer ${SUPABASE_ANON_KEY}`, 'Content-Type': 'application/json' }
                    });
                    if (propResponse.ok) {
                        const propData = await propResponse.json();
                        propData.forEach(p => { propertyMap[p.raw_row_id] = { county: p.county, address: p.property_address }; });
                    }
                }
            }

            rawData.forEach(item => {
                if (item.raw_row_id && propertyMap[item.raw_row_id]) {
                    item.county = propertyMap[item.raw_row_id].county;
                    item.property_address = propertyMap[item.raw_row_id].address;
                }
            });

            rawQueueItems = rawData;
            allQueueData = aggregateForOrderSheet(rawData);
            processQueueData(allQueueData);
        }

        function aggregateForOrderSheet(rawData) {
            const COUNTY_BATCH_SIZE = 10;
            const sortedData = [...rawData].sort((a, b) => {
                const priorityA = a.meta?.priority_rank || 999999;
                const priorityB = b.meta?.priority_rank || 999999;
                if (priorityA !== priorityB) return priorityA - priorityB;
                return new Date(a.next_action_at) - new Date(b.next_action_at);
            });

            const countySeq = {};
            sortedData.forEach(item => {
                const county = item.county || 'Unknown';
                countySeq[county] = (countySeq[county] || 0) + 1;
                item._county_seq = countySeq[county];
            });

            sortedData.sort((a, b) => {
                const batchA = Math.floor((a._county_seq - 1) / COUNTY_BATCH_SIZE);
                const batchB = Math.floor((b._county_seq - 1) / COUNTY_BATCH_SIZE);
                if (batchA !== batchB) return batchA - batchB;
                const countyA = (a.county || 'Unknown').toLowerCase();
                const countyB = (b.county || 'Unknown').toLowerCase();
                if (countyA !== countyB) return countyA.localeCompare(countyB);
                return a._county_seq - b._county_seq;
            });

            const groups = [];
            let currentGroup = null;
            sortedData.forEach((item) => {
                const channel = item.channel || 'unknown';
                const tier = item.meta?.urgency_tier || 'Unknown';
                const county = item.county || 'Unknown';
                const audience = item.meta?.audience_type || 'Unknown';
                const status = item.status || 'unknown';
                const batchNum = Math.floor((item._county_seq - 1) / COUNTY_BATCH_SIZE);
                const key = `${channel}|${tier}|${county}|${audience}|${status}|${batchNum}`;

                if (!currentGroup || currentGroup._key !== key) {
                    currentGroup = { _key: key, channel, tier, county, audience, status, count: 0, items: [] };
                    groups.push(currentGroup);
                }
                currentGroup.count++;
                currentGroup.items.push(item);
            });

            let runningTotal = 0;
            groups.forEach(group => {
                group.startPosition = runningTotal + 1;
                group.endPosition = runningTotal + group.count;
                runningTotal += group.count;
            });

            return groups;
        }

        function calculateEstSendTime(position) {
            const now = new Date();
            let startTime = new Date();
            const currentHour = now.getHours();
            if (currentHour < START_HOUR) { startTime.setHours(START_HOUR, 0, 0, 0); }
            else if (currentHour >= END_HOUR) { startTime.setDate(startTime.getDate() + 1); startTime.setHours(START_HOUR, 0, 0, 0); }
            const minutesFromStart = Math.floor((position - 1) / MESSAGES_PER_MINUTE);
            return new Date(startTime.getTime() + minutesFromStart * 60 * 1000);
        }

        function processQueueData(data) {
            let totalQueued = 0, smsCount = 0, voiceCount = 0, pendingCount = 0, sentCount = 0;
            const tierCounts = { V1: 0, V2: 0, V3: 0, V4: 0 };
            const audienceCounts = {};

            data.forEach(row => {
                const count = parseInt(row.count) || 0;
                totalQueued += count;
                if (row.channel === 'sms') smsCount += count;
                if (row.channel === 'voice') voiceCount += count;
                if (row.status === 'queued') pendingCount += count;
                if (row.status === 'sent') sentCount += count;
                const tier = row.tier || 'Unknown';
                if (tierCounts[tier] !== undefined) tierCounts[tier] += count;
                const audience = row.audience || 'Unknown';
                audienceCounts[audience] = (audienceCounts[audience] || 0) + count;
            });

            document.getElementById('totalQueued').textContent = totalQueued.toLocaleString();
            document.getElementById('smsCount').textContent = smsCount.toLocaleString();
            document.getElementById('voiceCount').textContent = voiceCount.toLocaleString();
            document.getElementById('pendingCount').textContent = pendingCount.toLocaleString();
            document.getElementById('sentCount').textContent = sentCount.toLocaleString();

            updateSummaryStats(totalQueued, audienceCounts, tierCounts, data);

            if (pendingCount > 0) {
                const estCompletion = calculateEstSendTime(pendingCount);
                document.getElementById('estCompletionTime').textContent = estCompletion.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit', hour12: true });
            } else {
                document.getElementById('estCompletionTime').textContent = 'DONE!';
            }

            updateTierChart(tierCounts);
            updateAudienceChart(audienceCounts);
            updateQueueTable(data);
        }

        function updateTierChart(tierCounts) {
            const ctx = document.getElementById('tierChart').getContext('2d');
            if (tierChart) tierChart.destroy();
            tierChart = new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: ['V1 (45+ days)', 'V2 (30-44 days)', 'V3 (14-29 days)', 'V4 (1-13 days)'],
                    datasets: [{ data: [tierCounts.V1, tierCounts.V2, tierCounts.V3, tierCounts.V4], backgroundColor: ['#00ffff', '#ffff00', '#ffa500', '#ff0000'], borderWidth: 2, borderColor: '#000000' }]
                },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom', labels: { font: { family: 'Times New Roman', size: 10 } } } } }
            });
        }

        function updateAudienceChart(audienceCounts) {
            const ctx = document.getElementById('audienceChart').getContext('2d');
            if (audienceChart) audienceChart.destroy();
            const labels = Object.keys(audienceCounts);
            const values = Object.values(audienceCounts);
            const colors = ['#00ffff', '#ff00ff', '#00ff00', '#ffa500', '#ff0000'];
            audienceChart = new Chart(ctx, {
                type: 'pie',
                data: { labels: labels.map(l => formatAudienceLabel(l)), datasets: [{ data: values, backgroundColor: colors.slice(0, labels.length), borderWidth: 2, borderColor: '#000000' }] },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom', labels: { font: { family: 'Times New Roman', size: 10 } } } } }
            });
        }

        function formatAudienceLabel(audience) {
            if (!audience) return 'Unknown';
            return audience.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
        }

        async function loadHourlyData() {
            if (rawQueueItems.length === 0) { updateHourlyChart([]); return; }
            const hourlyData = {};
            rawQueueItems.forEach(item => {
                if (item.next_action_at) {
                    const hour = new Date(item.next_action_at).getHours();
                    const channel = item.channel || 'unknown';
                    const key = `${hour}|${channel}`;
                    if (!hourlyData[key]) hourlyData[key] = { hour, channel, count: 0 };
                    hourlyData[key].count++;
                }
            });
            updateHourlyChart(Object.values(hourlyData));
        }

        function updateHourlyChart(data) {
            const ctx = document.getElementById('hourlyChart').getContext('2d');
            if (hourlyChart) hourlyChart.destroy();
            const hourlyTotals = {};
            for (let i = START_HOUR; i <= END_HOUR; i++) hourlyTotals[i] = { sms: 0, voice: 0 };
            data.forEach(row => {
                const hour = parseInt(row.hour);
                if (hour >= START_HOUR && hour <= END_HOUR) {
                    if (row.channel === 'sms') hourlyTotals[hour].sms += parseInt(row.count) || 0;
                    if (row.channel === 'voice') hourlyTotals[hour].voice += parseInt(row.count) || 0;
                }
            });
            const hours = Object.keys(hourlyTotals).map(h => `${h}:00`);
            const smsData = Object.values(hourlyTotals).map(v => v.sms);
            const voiceData = Object.values(hourlyTotals).map(v => v.voice);
            hourlyChart = new Chart(ctx, {
                type: 'bar',
                data: { labels: hours, datasets: [{ label: 'SMS', data: smsData, backgroundColor: '#00ff00', borderColor: '#000000', borderWidth: 1 }, { label: 'Voice', data: voiceData, backgroundColor: '#ff00ff', borderColor: '#000000', borderWidth: 1 }] },
                options: { responsive: true, maintainAspectRatio: false, scales: { x: { stacked: true }, y: { stacked: true } }, plugins: { legend: { position: 'top', labels: { font: { family: 'Times New Roman', size: 10 } } } } }
            });
        }

        function updateQueueTable(data) {
            const tbody = document.getElementById('queueTableBody');
            if (!data || data.length === 0) {
                tbody.innerHTML = `<tr><td colspan="8" class="empty-state">&#x1F4ED; No messages scheduled for today. Check back later!</td></tr>`;
                return;
            }
            const now = new Date();
            const currentHour = now.getHours();
            let currentBatchStart = 0;
            if (currentHour >= START_HOUR && currentHour < END_HOUR) {
                const startTime = new Date(); startTime.setHours(START_HOUR, 0, 0, 0);
                const minutesElapsed = Math.floor((now - startTime) / 60000);
                currentBatchStart = minutesElapsed * MESSAGES_PER_MINUTE;
            }
            tbody.innerHTML = data.map((row) => {
                const orderDisplay = row.count > 1 ? `${row.startPosition} - ${row.endPosition}` : `${row.startPosition}`;
                const estStartTime = calculateEstSendTime(row.startPosition);
                const estEndTime = calculateEstSendTime(row.endPosition);
                const formatTime = (t) => t.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit', hour12: true });
                const startTimeStr = formatTime(estStartTime);
                const endTimeStr = formatTime(estEndTime);
                const estTimeDisplay = (row.count > 3 && startTimeStr !== endTimeStr) ? `${startTimeStr} - ${endTimeStr}` : startTimeStr;
                const isCurrentBatch = row.startPosition <= currentBatchStart + 3 && row.endPosition >= currentBatchStart && row.status === 'queued';
                const tierLabel = getTierLabel(row.tier);
                return `
                <tr data-channel="${row.channel}" data-status="${row.status}" style="${isCurrentBatch ? 'background:#ffffcc;font-weight:bold;' : ''}">
                    <td><b>#${orderDisplay}</b></td>
                    <td>${row.status === 'sent' ? '<font color="#008000">SENT</font>' : estTimeDisplay}</td>
                    <td><span class="badge ${row.channel}">${(row.channel || '').toUpperCase()}</span></td>
                    <td><span class="badge ${(row.tier || '').toLowerCase()}">${row.tier || '-'}</span> <span class="tier-desc">${tierLabel}</span></td>
                    <td>${row.county || '-'}</td>
                    <td>${formatAudienceLabel(row.audience)}</td>
                    <td><span class="badge ${row.status}">${row.status || '-'}</span></td>
                    <td><b>${parseInt(row.count).toLocaleString()}</b></td>
                </tr>`;
            }).join('');
        }

        function getTierLabel(tier) {
            const labels = { 'V1': '45+ days', 'V2': '30-44 days', 'V3': '14-29 days', 'V4': '1-13 days' };
            return labels[tier] || '';
        }

        function updateSummaryStats(total, audienceCounts, tierCounts, data) {
            document.getElementById('summaryTotal').textContent = total.toLocaleString();
            const audienceItems = Object.entries(audienceCounts).filter(([k, v]) => v > 0).sort((a, b) => b[1] - a[1]).map(([name, count]) => {
                const pct = ((count / total) * 100).toFixed(1);
                return `<span class="pct">${pct}%</span> ${name.replace(/_/g, ' ')}`;
            });
            document.getElementById('audienceDistribution').innerHTML = audienceItems.join(', ');
            const tierItems = ['V1', 'V2', 'V3', 'V4'].filter(t => tierCounts[t] > 0).map(t => `<b>${t}</b> (${tierCounts[t].toLocaleString()})`);
            document.getElementById('tierDistribution').innerHTML = tierItems.join(', ');
            const countyCounts = {};
            data.forEach(row => { const county = row.county || 'Unknown'; countyCounts[county] = (countyCounts[county] || 0) + row.count; });
            const countyItems = Object.entries(countyCounts).sort((a, b) => b[1] - a[1]).slice(0, 5).map(([name, count]) => `${name} (${count.toLocaleString()})`);
            const countyDisplay = countyItems.join(', ');
            const totalCounties = Object.keys(countyCounts).length;
            document.getElementById('countyDistribution').innerHTML = countyDisplay + (totalCounties > 5 ? ` <b>+${totalCounties - 5} more</b>` : '');
        }

        function filterTable(filter) {
            document.querySelectorAll('#queueTableBody tr[data-channel]').forEach(row => {
                const channel = row.dataset.channel;
                const status = row.dataset.status;
                let show = true;
                if (filter === 'sms') show = channel === 'sms';
                else if (filter === 'voice') show = channel === 'voice';
                else if (filter === 'queued') show = status === 'queued';
                else if (filter === 'sent') show = status === 'sent';
                row.style.display = show ? '' : 'none';
            });
        }
    </script>
</body>
</html>
